<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin - Advanced</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tambola-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0.5rem;
            max-width: 600px;
            margin: 1rem auto;
        }
        .tambola-board .number-cell {
            @apply border rounded-md p-2 text-center text-sm sm:text-base font-semibold;
            transition: all 0.3s ease;
        }
        .tambola-board .number-cell.drawn {
            @apply bg-primary text-primary-content scale-110;
        }
        .floating-nav-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        main { padding-bottom: 80px; }
        .admin-section { @apply mb-8 p-4 bg-base-100 rounded-box shadow-lg; }
        .admin-section h3 { @apply text-xl font-semibold mb-3 text-center border-b pb-2; }
        .list-item { @apply p-2 border-b flex justify-between items-center; }
    </style>
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

    <div class="drawer lg:drawer-open">
        <input id="my-drawer-3" type="checkbox" class="drawer-toggle" />
        
        <div class="drawer-content flex flex-col">
            <div class="w-full navbar bg-base-300 sticky top-0 z-50 shadow-md">
                <div class="flex-none lg:hidden">
                    <label for="my-drawer-3" aria-label="open sidebar" class="btn btn-square btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </label>
                </div>
                <div class="flex-1 px-2 mx-2 font-bold text-xl">Tambola Admin Panel <span id="adminRoomDisplay" class="text-sm ml-2 badge badge-info hidden"></span></div>
                <div class="flex-none hidden lg:block">
                    <ul class="menu menu-horizontal">
                        <li><a href="/" class="font-semibold" target="_blank">Player View</a></li>
                        <li><button id="resetGameBtnTop" class="btn btn-sm btn-outline btn-warning" onclick="resetGame()">Reset SERVER</button></li>
                    </ul>
                </div>
            </div>

            <main class="container mx-auto p-4 flex-grow">
                <section class="admin-section">
                    <h3>Game Room Setup</h3>
                    <div class="form-control sm:flex-row gap-2 items-end">
                        <div class="flex-grow">
                            <label class="label" for="roomIdInput"><span class="label-text">Game Room ID</span></label>
                            <input type="text" id="roomIdInput" placeholder="Enter or Create Room ID" class="input input-bordered w-full" value="ROOM1"/>
                        </div>
                        <button id="connectRoomBtn" class="btn btn-accent sm:w-auto w-full" onclick="connectToRoom()">Connect to Room</button>
                    </div>
                    <div id="qrCodeCanvasContainer" class="mt-4 text-center hidden">
                        <p class="mb-2 font-semibold">Player Join QR Code:</p>
                        <div id="qrCodeCanvas" class="mx-auto border rounded-md inline-block"></div> <p id="playerJoinLink" class="text-sm mt-1 break-all"></p>
                    </div>
                </section>

                <div id="gameControlsSection" class="hidden">
                    <section class="admin-section">
                        <h3>Game Configuration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="label"><span class="label-text">Number Calling Mode</span></label>
                                <select id="modeSelector" class="select select-bordered w-full" onchange="toggleModeControls()">
                                    <option value="manual" selected>Manual</option>
                                    <option value="auto">Auto</option>
                                </select>
                            </div>
                            <div>
                                <label class="label"><span class="label-text">Auto-Call Interval (seconds)</span></label>
                                <select id="intervalSelector" class="select select-bordered w-full" disabled>
                                    <option value="3000">3 seconds</option>
                                    <option value="5000" selected>5 seconds</option>
                                    <option value="7000">7 seconds</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <section class="admin-section">
                        <h3>Winning Rules & Max Winners per Prize</h3>
                        <div id="winningRulesConfig" class="space-y-3">
                            </div>
                        <p id="ruleValidationError" class="text-error text-sm mt-2"></p>
                    </section>

                    <section class="admin-section">
                        <h3>Game Controls</h3>
                        <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-6">
                            <button id="startGameBtn" class="btn btn-success btn-wide" onclick="startGame()">Start Game in Room</button>
                            <button id="callNextBtn" class="btn btn-primary" onclick="drawNextNumber()">Call Next</button>
                            <button id="pauseGameBtn" class="btn btn-warning" onclick="pauseGame()" disabled>Pause Auto</button>
                            <button id="resumeGameBtn" class="btn btn-info" onclick="resumeGame()" disabled>Resume Auto</button>
                            <button id="stopGameBtn" class="btn btn-error btn-wide" onclick="stopGame()" disabled>Stop Game in Room</button>
                        </div>
                        <div id="currentNumberDisplay" class="text-center my-8 p-6 bg-base-100 rounded-box shadow-lg max-w-xs mx-auto">
                            <h2 class="text-xl font-semibold mb-2">Current Number:</h2>
                            <p id="currentNumber" class="text-6xl font-bold text-secondary">-</p>
                        </div>
                        <div id="gameStatus" class="text-center my-4 text-lg font-medium">
                            Status: <span id="statusText">Not Connected</span> | Numbers Left: <span id="numbersLeftText">90</span>
                        </div>
                        <div id="gameOverMessage" class="text-center my-4 text-2xl font-bold text-error hidden">GAME OVER!</div>
                    </section>

                    <section class="admin-section">
                        <h3>Tambola Board (1-90)</h3>
                        <div id="tambolaBoard" class="tambola-board bg-base-100 p-4 rounded-box shadow"></div>
                    </section>

                    <section class="admin-section">
                        <h3>Drawn Numbers (<span id="drawnCount">0</span>/90)</h3>
                        <div id="drawnNumbersList" class="p-4 bg-base-100 rounded-box shadow min-h-[50px] flex flex-wrap gap-2 justify-center items-center">
                            <span class="italic text-gray-500">No numbers drawn yet.</span>
                        </div>
                    </section>

                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <section class="admin-section">
                            <h3>Connected Players (<span id="playerCount">0</span>)</h3>
                            <div id="playerList" class="max-h-60 overflow-y-auto">
                                <p class="italic text-gray-500 p-2">No players connected yet.</p>
                            </div>
                        </section>

                        <section class="admin-section">
                            <h3>Ticket Requests (<span id="ticketRequestCount">0</span>)</h3>
                            <div id="ticketRequestList" class="max-h-60 overflow-y-auto">
                                <p class="italic text-gray-500 p-2">No pending ticket requests.</p>
                            </div>
                        </section>

                        <section class="admin-section">
                            <h3>Pending Claims (<span id="claimCount">0</span>)</h3>
                            <div id="claimList" class="max-h-60 overflow-y-auto">
                                <p class="italic text-gray-500 p-2">No pending claims.</p>
                            </div>
                        </section>
                    </div>
                    <section class="admin-section">
                        <h3>Approved Winners</h3>
                        <div id="winnersList" class="max-h-60 overflow-y-auto">
                             <p class="italic text-gray-500 p-2">No winners declared yet.</p>
                        </div>
                    </section>
                </div> 
            </main>
        </div> 
        
        <div class="drawer-side z-[60]"> 
            <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label> 
            <ul class="menu p-4 w-80 min-h-full bg-base-200">
                <li class="menu-title">Admin Menu</li>
                <li><a href="/" target="_blank">Player View</a></li>
                <li><button class="btn btn-sm btn-outline btn-warning w-full mt-2" onclick="resetGame()">Reset ENTIRE SERVER</button></li>
                <li><button class="btn btn-sm btn-outline btn-error w-full mt-2" onclick="stopGame()">Stop Game in Current Room</button></li>
                <li class="mt-4"><div class="divider"></div></li>
                <li><a onclick="document.getElementById('my-drawer-3').checked = false;">Close Menu</a></li>
            </ul>
        </div>
    </div>

    <div class="floating-nav-container btm-nav lg:hidden">
        <button id="floatStartBtn" class="text-success" onclick="startGame()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span class="btm-nav-label">Start</span>
        </button>
        <button id="floatCallNextBtn" class="text-primary" onclick="drawNextNumber()">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
            <span class="btm-nav-label">Call Next</span>
        </button>
        <button id="floatStopBtn" class="text-error" onclick="stopGame()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12H3m18 0a9 9 0 11-18 0 9 9 0 0118 0zM12 9v6" transform="rotate(45 12 12)" /></svg>
            <span class="btm-nav-label">Stop</span>
        </button>
    </div>

    <script>
        // !!! IMPORTANT: Set your Render Backend URL here !!!
        const API_BASE_URL = 'https://tambola-backend.onrender.com'; 
        
        // !!! IMPORTANT: Set your Netlify Frontend URL here for QR Code !!!
        const FRONTEND_BASE_URL = 'https://mytambola.netlify.app'; 

        // DOM Elements
        const roomIdInput = document.getElementById('roomIdInput');
        const connectRoomBtn = document.getElementById('connectRoomBtn');
        const adminRoomDisplay = document.getElementById('adminRoomDisplay');
        const qrCodeCanvasContainer = document.getElementById('qrCodeCanvasContainer');
        const qrCodeCanvas = document.getElementById('qrCodeCanvas'); // This is now a div
        const playerJoinLink = document.getElementById('playerJoinLink');
        const gameControlsSection = document.getElementById('gameControlsSection');

        const modeSelector = document.getElementById('modeSelector');
        const intervalSelector = document.getElementById('intervalSelector');
        const winningRulesConfigEl = document.getElementById('winningRulesConfig');
        const ruleValidationError = document.getElementById('ruleValidationError');
        
        const startGameBtn = document.getElementById('startGameBtn');
        const callNextBtn = document.getElementById('callNextBtn');
        const pauseGameBtn = document.getElementById('pauseGameBtn');
        const resumeGameBtn = document.getElementById('resumeGameBtn');
        const stopGameBtn = document.getElementById('stopGameBtn');
        const resetGameBtnTop = document.getElementById('resetGameBtnTop');

        const currentNumberEl = document.getElementById('currentNumber');
        const tambolaBoard = document.getElementById('tambolaBoard');
        const drawnNumbersListEl = document.getElementById('drawnNumbersList');
        const drawnCountEl = document.getElementById('drawnCount');
        const statusTextEl = document.getElementById('statusText');
        const numbersLeftTextEl = document.getElementById('numbersLeftText');
        const gameOverMessageEl = document.getElementById('gameOverMessage');
        
        const playerListEl = document.getElementById('playerList');
        const playerCountEl = document.getElementById('playerCount');
        const ticketRequestListEl = document.getElementById('ticketRequestList');
        const ticketRequestCountEl = document.getElementById('ticketRequestCount');
        const claimListEl = document.getElementById('claimList');
        const claimCountEl = document.getElementById('claimCount');
        const winnersListEl = document.getElementById('winnersList');

        const floatStartBtn = document.getElementById('floatStartBtn');
        const floatCallNextBtn = document.getElementById('floatCallNextBtn');
        const floatStopBtn = document.getElementById('floatStopBtn');

        // Game State
        let currentRoomId = null; 
        let autoCallIntervalId = null;
        let isGamePaused = false;
        let serverGameState = {}; 
        let pollingAdminIntervalId = null;

        const defaultWinningRules = {
            fullHouse: { name: "Full House", maxWinners: 1, enabled: true },
            firstLine: { name: "First Line", maxWinners: 1, enabled: true },
            secondLine: { name: "Second Line", maxWinners: 1, enabled: true },
            thirdLine: { name: "Third Line", maxWinners: 1, enabled: true },
            earlyFive: { name: "Early Five", maxWinners: 1, enabled: true },
            corners: { name: "Corners (4)", maxWinners: 1, enabled: true }
        };

        function initAdminUI() {
             if (!API_BASE_URL || API_BASE_URL === 'YOUR_RENDER_BACKEND_URL_HERE') { // Added safety check
                alert("CRITICAL: API_BASE_URL is not set correctly in the frontend JavaScript. Please check admin.html.");
                connectRoomBtn.disabled = true;
            }
             if (!FRONTEND_BASE_URL || FRONTEND_BASE_URL === 'YOUR_NETLIFY_FRONTEND_URL_HERE') { // Added safety check
                alert("CRITICAL: FRONTEND_BASE_URL is not set correctly in the frontend JavaScript. Please check admin.html.");
                connectRoomBtn.disabled = true;
            }
            tambolaBoard.innerHTML = '';
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.classList.add('number-cell');
                cell.id = `cell-${i}`;
                cell.textContent = i;
                tambolaBoard.appendChild(cell);
            }
            renderWinningRulesConfig();
        }
        initAdminUI();


        function renderWinningRulesConfig() {
            winningRulesConfigEl.innerHTML = '';
            for (const key in defaultWinningRules) {
                const rule = defaultWinningRules[key];
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="cursor-pointer label justify-start gap-2">
                        <input type="checkbox" id="rule${capitalizeFirstLetter(key)}" class="checkbox checkbox-primary" data-rule="${key}" onchange="toggleMaxPrizeInput('${key}')" ${rule.enabled ? 'checked' : ''} />
                        <span class="label-text">${rule.name}</span>
                    </label>
                    <input type="number" id="max${capitalizeFirstLetter(key)}" class="input input-sm input-bordered w-20 ml-4" value="${rule.maxWinners}" min="1" ${!rule.enabled ? 'disabled' : ''} />
                `;
                winningRulesConfigEl.appendChild(div);
            }
        }


        async function connectToRoom() {
            const newRoomId = roomIdInput.value.trim();
            if (!newRoomId) {
                alert("Please enter a Room ID.");
                return;
            }
            currentRoomId = newRoomId; 
            
            roomIdInput.disabled = true;
            connectRoomBtn.disabled = true;
            connectRoomBtn.textContent = "Connected";
            adminRoomDisplay.textContent = `Room: ${currentRoomId}`;
            adminRoomDisplay.classList.remove('hidden');
            gameControlsSection.classList.remove('hidden');
            statusTextEl.textContent = "Ready to Start";
            
            // Use the configured FRONTEND_BASE_URL for the player join link
            const playerUrl = `${FRONTEND_BASE_URL}/?roomId=${encodeURIComponent(currentRoomId)}`; 
            playerJoinLink.textContent = playerUrl;
            playerJoinLink.href = playerUrl; // Make it a clickable link too
            try {
                qrCodeCanvas.innerHTML = ''; 
                const qr = qrcode(0, 'L'); 
                qr.addData(playerUrl);
                qr.make();
                qrCodeCanvas.innerHTML = qr.createImgTag(4, 8); 
                qrCodeCanvasContainer.classList.remove('hidden');
            } catch (e) {
                console.error("QR Code generation failed:", e);
                qrCodeCanvasContainer.innerHTML = "<p class='text-error'>QR Code generation failed.</p>";
                qrCodeCanvasContainer.classList.remove('hidden');
            }
            
            await fetchAdminData(); 
            updateButtonStates();

            if(pollingAdminIntervalId) clearInterval(pollingAdminIntervalId);
            pollingAdminIntervalId = setInterval(fetchAdminData, 7000); 
        }

        function toggleModeControls() {
            const isAutoMode = modeSelector.value === 'auto';
            intervalSelector.disabled = !isAutoMode || (serverGameState && serverGameState.gameStarted);
            if (!isAutoMode && autoCallIntervalId) { 
                clearInterval(autoCallIntervalId);
                autoCallIntervalId = null;
                isGamePaused = false; 
            }
            updateButtonStates(); 
        }
        
        function toggleMaxPrizeInput(ruleKey) {
            const checkbox = document.getElementById(`rule${capitalizeFirstLetter(ruleKey)}`);
            const input = document.getElementById(`max${capitalizeFirstLetter(ruleKey)}`);
            if (input) {
                input.disabled = !checkbox.checked || (serverGameState && serverGameState.gameStarted);
                if (!checkbox.checked) input.value = defaultWinningRules[ruleKey]?.maxWinners || "1";
            }
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function getSelectedRules() {
            const rules = {};
            const ruleCheckboxes = winningRulesConfigEl.querySelectorAll('input[type="checkbox"]');
            let oneRuleSelected = false;
            ruleCheckboxes.forEach(cb => {
                const ruleKey = cb.dataset.rule;
                const maxWinnersInput = document.getElementById(`max${capitalizeFirstLetter(ruleKey)}`);
                if (cb.checked) {
                    oneRuleSelected = true;
                    rules[ruleKey] = {
                        enabled: true,
                        maxWinners: parseInt(maxWinnersInput.value) || 1
                    };
                } else {
                     rules[ruleKey] = { 
                        enabled: false,
                        maxWinners: parseInt(maxWinnersInput.value) || 1
                    };
                }
            });
            if (!oneRuleSelected) {
                ruleValidationError.textContent = "At least one winning rule must be selected to start.";
                return null;
            }
            ruleValidationError.textContent = "";
            return rules;
        }


        async function fetchAdminData() { 
            if (!currentRoomId) {
                updateAdminUI({ message: "Not connected to any room."}); 
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/state?roomId=${currentRoomId}`); // USE API_BASE_URL
                if (!response.ok) {
                    const errText = await response.text();
                    if (response.status === 404) {
                         throw new Error(`Room '${currentRoomId}' not found on backend.`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}, ${errText}`);
                }
                serverGameState = await response.json();
                updateAdminUI(serverGameState);
            } catch (error) {
                console.error("Failed to fetch admin game state:", error);
                statusTextEl.textContent = `Error fetching state: ${error.message}`;
            }
        }

        function updateAdminUI(state) {
            serverGameState = state; 
            if (state.message && !state.roomId) { 
                statusTextEl.textContent = state.message;
                currentNumberEl.textContent = '-';
                drawnNumbersListEl.innerHTML = `<span class="italic text-gray-500">Not connected.</span>`;
                playerListEl.innerHTML = `<p class="italic text-gray-500 p-2">Not connected.</p>`;
                ticketRequestListEl.innerHTML = `<p class="italic text-gray-500 p-2">Not connected.</p>`;
                claimListEl.innerHTML = `<p class="italic text-gray-500 p-2">Not connected.</p>`;
                winnersListEl.innerHTML = `<p class="italic text-gray-500 p-2">Not connected.</p>`;
                gameControlsSection.classList.add('hidden'); 
                roomIdInput.disabled = false;
                connectRoomBtn.disabled = false;
                connectRoomBtn.textContent = "Connect to Room";
                adminRoomDisplay.classList.add('hidden');
                if (pollingAdminIntervalId) clearInterval(pollingAdminIntervalId); 
                pollingAdminIntervalId = null;
                return;
            }


            currentNumberEl.textContent = state.currentNumber || '-';

            document.querySelectorAll('.tambola-board .number-cell').forEach(cell => cell.classList.remove('drawn'));
            (state.drawnNumbers || []).forEach(num => {
                const cell = document.getElementById(`cell-${num}`);
                if (cell) cell.classList.add('drawn');
            });

            drawnCountEl.textContent = state.drawnNumbers?.length || 0;
            drawnNumbersListEl.innerHTML = (state.drawnNumbers && state.drawnNumbers.length > 0) ? 
                state.drawnNumbers.map(num => `<span class="badge badge-lg badge-neutral">${num}</span>`).join(' ') :
                `<span class="italic text-gray-500">No numbers drawn yet.</span>`;

            if (state.gameOver) {
                statusTextEl.textContent = "Game Over";
                gameOverMessageEl.classList.remove('hidden');
                if (autoCallIntervalId) clearInterval(autoCallIntervalId);
                autoCallIntervalId = null;
            } else if (state.gameStarted) {
                statusTextEl.textContent = `In Progress (Mode: ${modeSelector.value})`;
                gameOverMessageEl.classList.add('hidden');
            } else {
                 statusTextEl.textContent = currentRoomId ? "Ready to Start" : "Not Connected";
                gameOverMessageEl.classList.add('hidden');
            }
            numbersLeftTextEl.textContent = state.numbersLeft !== undefined ? state.numbersLeft : 90;

            playerCountEl.textContent = state.players?.length || 0;
            playerListEl.innerHTML = (state.players && state.players.length > 0) ?
                state.players.map(player => `<div class="list-item">${player.name} (ID: ...${player.id.slice(-4)}, Tickets: ${player.ticketCount})</div>`).join('') :
                `<p class="italic text-gray-500 p-2">No players connected.</p>`;

            ticketRequestCountEl.textContent = state.ticketRequests?.length || 0;
            ticketRequestListEl.innerHTML = (state.ticketRequests && state.ticketRequests.length > 0) ?
                state.ticketRequests.map(req => `
                    <div class="list-item">
                        <span>${req.playerName} (PlayerID: ...${req.playerId.slice(-4)})</span>
                        <button class="btn btn-xs btn-outline btn-success" onclick="approveTicket('${req.requestId}')">Approve</button>
                    </div>`).join('') :
                `<p class="italic text-gray-500 p-2">No pending ticket requests.</p>`;

            claimCountEl.textContent = state.claims?.length || 0;
            claimListEl.innerHTML = (state.claims && state.claims.length > 0) ?
                state.claims.map(claim => `
                    <div class="list-item">
                        <span>${capitalizeFirstLetter(claim.prizeType)} by ${claim.playerName} (Ticket: ...${claim.ticketId.slice(-6)})</span>
                        <div>
                            <button class="btn btn-xs btn-outline btn-success mr-1" onclick="processClaim('${claim.claimId}', 'accept')">Accept</button>
                            <button class="btn btn-xs btn-outline btn-error" onclick="processClaim('${claim.claimId}', 'reject')">Reject</button>
                        </div>
                    </div>`).join('') :
                `<p class="italic text-gray-500 p-2">No pending claims.</p>`;
            
            winnersListEl.innerHTML = ''; 
            if (state.winners && Object.keys(state.winners).length > 0) {
                let winnersHtml = '';
                for (const prize in state.winners) {
                    if (state.winners[prize].length > 0) {
                        winnersHtml += `<div class="p-2 border-b"><strong>${capitalizeFirstLetter(prize.replace(/([A-Z])/g, ' $1'))}:</strong> ${state.winners[prize].map(w => `${w.playerName} (Ticket ...${w.ticketId.slice(-6)})`).join(', ')}</div>`;
                    }
                }
                winnersListEl.innerHTML = winnersHtml || '<p class="italic text-gray-500 p-2">No winners declared yet.</p>';
            } else {
                winnersListEl.innerHTML = '<p class="italic text-gray-500 p-2">No winners declared yet.</p>';
            }
            
            const gameCanBeConfigured = !state.gameStarted || state.gameOver;
            modeSelector.disabled = !gameCanBeConfigured;
            intervalSelector.disabled = !gameCanBeConfigured || modeSelector.value !== 'auto';
            winningRulesConfigEl.querySelectorAll('input').forEach(input => input.disabled = !gameCanBeConfigured);

            updateButtonStates();
        }
        
        function updateButtonStates() {
            const gameStarted = serverGameState.gameStarted;
            const gameOver = serverGameState.gameOver;
            const isAuto = modeSelector.value === 'auto';
            const isConnected = !!currentRoomId;

            startGameBtn.disabled = !isConnected || gameStarted || gameOver;
            floatStartBtn.disabled = !isConnected || gameStarted || gameOver;

            callNextBtn.disabled = !isConnected || isAuto || !gameStarted || gameOver;
            floatCallNextBtn.disabled = !isConnected || isAuto || !gameStarted || gameOver;
            
            pauseGameBtn.disabled = !isConnected || !isAuto || !gameStarted || gameOver || isGamePaused;
            resumeGameBtn.disabled = !isConnected || !isAuto || !gameStarted || gameOver || !isGamePaused;

            stopGameBtn.disabled = !isConnected || !gameStarted || gameOver;
            floatStopBtn.disabled = !isConnected || !gameStarted || gameOver;
            
            resetGameBtnTop.disabled = false; 
        }


        async function startGame() {
            if (!currentRoomId) {
                alert("Not connected to a room. Cannot start game.");
                return;
            }
            const selectedRules = getSelectedRules();
            if (!selectedRules) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/start-game`, { // USE API_BASE_URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        roomId: currentRoomId, 
                        rules: selectedRules,
                        mode: modeSelector.value 
                    })
                });
                if (!response.ok) {
                     const errorData = await response.json();
                     alert(`Error starting game: ${errorData.message}`);
                     throw new Error(`HTTP error! status: ${response.status}`);
                }
                await fetchAdminData(); 
                if (modeSelector.value === 'auto' && !isGamePaused && serverGameState.gameStarted && !serverGameState.gameOver) {
                    startAutoCalling();
                }
            } catch (error) {
                console.error("Failed to start game:", error);
            }
        }
        
        function startAutoCalling() {
            if (autoCallIntervalId) clearInterval(autoCallIntervalId); 
            const interval = parseInt(intervalSelector.value);
            autoCallIntervalId = setInterval(async () => {
                if (serverGameState.gameOver || isGamePaused || !serverGameState.gameStarted) {
                    clearInterval(autoCallIntervalId);
                    autoCallIntervalId = null;
                    updateButtonStates(); 
                    return;
                }
                await drawNextNumber(); 
            }, interval);
            isGamePaused = false; 
            updateButtonStates();
        }

        async function drawNextNumber() {
            if (!currentRoomId || serverGameState.gameOver || !serverGameState.gameStarted) return;
            try {
                if (modeSelector.value === 'manual') callNextBtn.disabled = true;

                const response = await fetch(`${API_BASE_URL}/api/admin/draw-number`, { // USE API_BASE_URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: currentRoomId }) 
                });
                 if (!response.ok) {
                     const errorData = await response.json();
                     alert(`Error drawing number: ${errorData.message}`);
                     if (errorData.gameOver) { 
                         serverGameState.gameOver = true;
                     }
                     throw new Error(`HTTP error! status: ${response.status}, Message: ${errorData.message}`);
                }
                await fetchAdminData(); 
            } catch (error) {
                console.error("Failed to draw number:", error);
                await fetchAdminData();
            } 
        }

        function pauseGame() {
            if (modeSelector.value === 'auto' && autoCallIntervalId) {
                clearInterval(autoCallIntervalId);
                autoCallIntervalId = null;
                isGamePaused = true;
                statusTextEl.textContent = `Paused (Mode: Auto, Room: ${currentRoomId})`;
                updateButtonStates();
            }
        }

        function resumeGame() {
             if (modeSelector.value === 'auto' && isGamePaused && serverGameState.gameStarted && !serverGameState.gameOver) {
                isGamePaused = false;
                startAutoCalling(); 
                statusTextEl.textContent = `In Progress (Mode: Auto, Room: ${currentRoomId})`;
            }
        }
        
        async function stopGame() {
            if (!currentRoomId || !serverGameState.gameStarted) {
                 alert("Game not started in the current room or not connected.");
                 return;
            }
            if (!confirm(`Are you sure you want to stop the game in room ${currentRoomId}?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/stop-game`, { // USE API_BASE_URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: currentRoomId })
                });
                if (!response.ok) throw new Error(await response.text());
                await fetchAdminData();
                 if (autoCallIntervalId) clearInterval(autoCallIntervalId);
                autoCallIntervalId = null;
                isGamePaused = false;
            } catch (error) {
                console.error("Failed to stop game:", error);
                alert("Error stopping game: " + error.message);
            }
        }
        
        async function resetGame() { 
            if (!confirm("DANGER! This will reset THE ENTIRE SERVER, deleting all rooms and game progress. Are you absolutely sure?")) {
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/reset-game`, { method: 'POST' }); // USE API_BASE_URL
                if (!response.ok) throw new Error(await response.text());
                
                if (autoCallIntervalId) clearInterval(autoCallIntervalId);
                autoCallIntervalId = null;
                isGamePaused = false;
                currentRoomId = null; 
                serverGameState = {}; 
                
                roomIdInput.disabled = false;
                roomIdInput.value = "ROOM1"; 
                connectRoomBtn.disabled = false;
                connectRoomBtn.textContent = "Connect to Room";
                adminRoomDisplay.classList.add('hidden');
                adminRoomDisplay.textContent = '';
                gameControlsSection.classList.add('hidden');
                qrCodeCanvasContainer.classList.add('hidden');
                qrCodeCanvas.innerHTML = '';
                playerJoinLink.textContent = '';
                
                renderWinningRulesConfig(); 

                updateAdminUI({ message: "Server has been reset. Connect to a room."}); 
                if(pollingAdminIntervalId) clearInterval(pollingAdminIntervalId);
                pollingAdminIntervalId = null;
                alert("Server reset successfully!");

            } catch (error) {
                console.error("Failed to reset server:", error);
                alert("Error resetting server: " + error.message);
            }
        }

        async function approveTicket(requestId) {
            if (!currentRoomId) { alert("Not connected to a room."); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/approve-ticket`, { // USE API_BASE_URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId, roomId: currentRoomId })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    alert("Error approving ticket: " + (errData.message || "Unknown error"));
                    throw new Error(errData.message || await response.text());
                }
                await fetchAdminData(); 
            } catch (error) {
                console.error("Failed to approve ticket:", error);
            }
        }

        async function processClaim(claimId, action) { 
            if (!currentRoomId) { alert("Not connected to a room."); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/process-claim`, { // USE API_BASE_URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ claimId, action, roomId: currentRoomId })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    alert(`Error processing claim: ${errData.message}`);
                    throw new Error(errData.message);
                }
                await fetchAdminData(); 
            } catch (error) {
                console.error("Failed to process claim:", error);
            }
        }
        updateButtonStates(); 
    </script>
</body>
</html>
