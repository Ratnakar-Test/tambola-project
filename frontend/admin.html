<!DOCTYPE html>
<html lang="en">
<head>
  <!-- BLOCK 1: HEAD (Imports & Metadata) -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tambola Admin Dashboard</title>
  <!-- DaisyUI & Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Socket.IO client -->
  <script src="https://tambola-backend.onrender.com/socket.io/socket.io.js"></script>
  <!-- QR code generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body x-data="adminDashboard()" x-init="init()" class="bg-base-200">

  <!-- BLOCK 2: SETUP SCREEN -->
  <div x-show="!connected" class="hero min-h-screen bg-base-200">
    <div class="hero-content text-center">
      <div class="max-w-md w-full space-y-4">
        <h1 class="text-5xl font-bold">Tambola Admin</h1>

        <!-- Admin Name & Room ID -->
        <input x-model="adminName" type="text" placeholder="Your Name"
               class="input input-bordered w-full"/>
        <input x-model="roomId" type="text" placeholder="Room ID"
               class="input input-bordered w-full"/>

        <!-- Winning Rule Checkboxes -->
        <div class="space-y-2 text-left">
          <label class="font-semibold">Select Prize Rules:</label>
          <template x-for="rule in Object.keys(rules)" :key="rule">
            <div class="flex items-center">
              <input type="checkbox" :id="rule" x-model="rules[rule]" class="checkbox mr-2"/>
              <label :for="rule" x-text="rule"></label>
              <input x-show="rules[rule]" type="number" min="1" x-model.number="maxPrizes[rule]"
                     class="input input-sm input-bordered w-16 ml-4" />
            </div>
          </template>
        </div>

        <!-- Max Tickets per Player -->
        <input x-model.number="maxTickets" type="number" min="1"
               placeholder="Max Tickets per Player" class="input input-bordered w-full"/>

        <!-- Create / Join -->
        <div class="flex space-x-4">
          <button @click="createRoom()" class="btn btn-primary flex-1">Create</button>
          <button @click="joinRoom()"   class="btn btn-secondary flex-1">Join</button>
        </div>

        <div x-show="errorMsg" class="alert alert-error shadow-lg">
          <div><span x-text="errorMsg"></span>
            <button @click="errorMsg=''" class="btn btn-sm btn-ghost ml-4">OK</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BLOCK 3: DRAWER LAYOUT -->
  <div x-show="connected" class="drawer drawer-mobile h-screen">
    <input id="sidebar-toggle" type="checkbox" class="drawer-toggle"/>

    <!-- MAIN CONTENT -->
    <div class="drawer-content flex flex-col">

      <!-- HEADER -->
      <header class="flex items-center p-4 bg-white shadow">
        <label for="sidebar-toggle" class="btn btn-ghost btn-square mr-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </label>
        <h1 class="text-2xl font-semibold flex-1">Room: <span x-text="roomId" class="font-mono"></span></h1>
        <!-- QR Code -->
        <canvas x-ref="qrCanvas" class="w-24 h-24 mr-4"></canvas>
        <!-- Controls -->
        <div class="flex space-x-2 items-center">
          <button @click="start()"
                  :disabled="gameState!=='stopped' || !hasRule"
                  class="btn btn-primary"
          >Start</button>

          <!-- Manual Mode -->
          <button @click="callNumber()"
                  x-show="mode==='Manual' && gameState==='running'"
                  class="btn btn-info"
          >Call Next</button>

          <!-- Auto Mode -->
          <button @click="pause()"
                  x-show="mode==='Auto' && gameState==='running'"
                  class="btn btn-warning"
          >Pause</button>
          <button @click="resume()"
                  x-show="mode==='Auto' && gameState==='paused'"
                  class="btn btn-success"
          >Resume</button>

          <!-- Stop -->
          <button @click="stop()"
                  x-show="gameState==='running' || gameState==='paused'"
                  class="btn btn-error"
          >Stop</button>

          <!-- Mode & Interval -->
          <select x-model="mode" class="select select-bordered w-24">
            <option>Manual</option>
            <option>Auto</option>
          </select>
          <select x-model.number="interval"
                  x-show="mode==='Auto'"
                  class="select select-bordered w-24"
          >
            <option>3</option><option>5</option><option>7</option>
          </select>
        </div>
      </header>

      <!-- TABS CONTENT -->
      <main class="p-4 overflow-auto flex-1 space-y-6">

        <!-- Numbers Grid -->
        <section x-show="currentTab==='Numbers'">
          <h2 class="text-xl font-semibold mb-2">Number Grid</h2>
          <div class="grid grid-cols-10 gap-2 bg-white p-2 rounded-lg shadow-inner">
            <template x-for="n in 90" :key="n">
              <div @click="toggleNumber(n)"
                   class="p-2 border rounded cursor-pointer text-center"
                   :class="called.includes(n)?'bg-primary text-white hover:bg-primary':'hover:bg-base-200'"
              >
                <span x-text="n"></span>
              </div>
            </template>
          </div>
        </section>

        <!-- Players List -->
        <section x-show="currentTab==='Players'">
          <h2 class="text-xl font-semibold mb-2">Players</h2>
          <ul class="list-disc list-inside bg-white p-4 rounded-lg shadow-inner">
            <template x-for="p in players" :key="p">
              <li x-text="p"></li>
            </template>
          </ul>
        </section>

        <!-- Ticket Requests -->
        <section x-show="currentTab==='Ticket Requests'">
          <h2 class="text-xl font-semibold mb-2">Ticket Requests</h2>
          <template x-for="req in ticketRequests" :key="req.requestId">
            <div class="flex justify-between items-center p-2 border-b bg-white rounded-lg shadow-inner mb-2">
              <span x-text="req.playerName"></span>
              <div class="space-x-2">
                <button @click="approveRequest(req.requestId)" class="btn btn-sm btn-success">✔</button>
                <button @click="rejectRequest(req.requestId)"  class="btn btn-sm btn-error">✖</button>
              </div>
            </div>
          </template>
        </section>

        <!-- Prize Claims -->
        <section x-show="currentTab==='Prize Claims'">
          <h2 class="text-xl font-semibold mb-2">Prize Claims</h2>
          <template x-for="c in prizeClaims" :key="c.claimId">
            <div class="flex justify-between items-center p-2 border-b bg-white rounded-lg shadow-inner mb-2">
              <span x-text="c.playerName + ' → ' + c.claimType"></span>
              <div class="space-x-2">
                <button @click="approveClaim(c.claimId)" class="btn btn-sm btn-success">✔</button>
                <button @click="rejectClaim(c.claimId)"  class="btn btn-sm btn-error">✖</button>
              </div>
            </div>
          </template>
        </section>

        <!-- Winners List -->
        <section x-show="currentTab==='Winners'">
          <h2 class="text-xl font-semibold mb-2">Winners</h2>
          <template x-for="w in winners" :key="w.playerName + w.prize">
            <div class="bg-white p-2 rounded-lg shadow-inner mb-2">
              <span x-text="w.prize + ': ' + w.playerName"></span>
            </div>
          </template>
        </section>

      </main>
    </div>

    <!-- SIDEBAR -->
    <div class="drawer-side">
      <label for="sidebar-toggle" class="drawer-overlay"></label>
      <aside class="p-6 w-64 bg-base-300 rounded-r-lg">
        <ul class="space-y-2">
          <li><a href="#" @click.prevent="currentTab='Numbers'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Numbers'?'font-bold':''"
                 class="block py-2 px-4 rounded hover:bg-base-200">Numbers</a></li>
          <li><a href="#" @click.prevent="currentTab='Players'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Players'?'font-bold':''"
                 class="block py-2 px-4 rounded hover:bg-base-200">Players</a></li>
          <li><a href="#" @click.prevent="currentTab='Ticket Requests'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Ticket Requests'?'font-bold':''"
                 class="block py-2 px-4 rounded hover:bg-base-200">Ticket Requests</a></li>
          <li><a href="#" @click.prevent="currentTab='Prize Claims'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Prize Claims'?'font-bold':''"
                 class="block py-2 px-4 rounded hover:bg-base-200">Prize Claims</a></li>
          <li><a href="#" @click.prevent="currentTab='Winners'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Winners'?'font-bold':''"
                 class="block py-2 px-4 rounded hover:bg-base-200">Winners</a></li>
        </ul>
      </aside>
    </div>
  </div>

  <!-- BLOCK 6: Alpine Component Script -->
  <script>
    function adminDashboard() {
      return {
        // State
        connected: false,
        roomId: '',
        adminName: '',
        maxTickets: 5,
        errorMsg: '',
        rules: {
          'Top Line': false,
          'Two Lines': false,
          'Full House': false
        },
        maxPrizes: {
          'Top Line': 1,
          'Two Lines': 1,
          'Full House': 1
        },
        currentTab: 'Numbers',
        mode: 'Manual',
        interval: 3,
        gameState: 'stopped', // 'stopped' | 'running' | 'paused'
        called: [],
        players: [],
        ticketRequests: [],
        prizeClaims: [],
        winners: [],
        socket: null,

        init() {
          this.socket = io('https://tambola-backend.onrender.com');
          this.socket.on('connect_error', () => this.errorMsg = 'Cannot reach server');
          this.socket.on('room-created', data => {
            this.roomId = data.roomId;
            this.connected = true;
            this.generateQR();
          });
          this.socket.on('player-joined', data => this.players = data.players);
          this.socket.on('number-called', data => this.called = data.calledNumbers);
          this.socket.on('ticket-requested', data =>
            this.ticketRequests.push({ requestId: data.requestId, playerName: data.playerName })
          );
          this.socket.on('claim-submitted', data =>
            this.prizeClaims.push({ claimId: data.claimId, playerName: data.playerName, claimType: data.claimType })
          );
          this.socket.on('claim-updated', data => {
            if (data.approved) {
              this.winners.push({ playerName: data.playerName, prize: data.claimType });
            }
          });
        },

        // Computed
        get hasRule() {
          return Object.values(this.rules).some(Boolean);
        },

        // Actions
        createRoom() {
          this.errorMsg = '';
          if (!this.adminName) { this.errorMsg = 'Enter your name'; return; }
          this.socket.emit('create-room',
            { adminName: this.adminName, maxTicketsPerPlayer: this.maxTickets },
            res => {
              if (!res.success) this.errorMsg = res.error;
            }
          );
        },

        joinRoom() {
          this.errorMsg = '';
          if (!this.adminName || !this.roomId) {
            this.errorMsg = 'Name & Room ID required'; return;
          }
          this.socket.emit('join-room',
            { roomId: this.roomId.trim().toUpperCase(), playerName: this.adminName },
            res => {
              if (res.success) {
                this.connected = true;
                this.generateQR();
              } else {
                this.errorMsg = res.error;
              }
            }
          );
        },

        start() {
          if (!this.hasRule) {
            this.errorMsg = 'Select at least one prize rule';
            return;
          }
          this.gameState = 'running';
          // (Optionally emit start-game with rules & maxPrizes)
        },

        callNumber() {
          const rid = this.roomId.trim().toUpperCase();
          this.socket.emit('call-number', { roomId: rid }, res => {
            if (!res.success) this.errorMsg = res.error;
          });
        },

        pause() {
          this.gameState = 'paused';
        },

        resume() {
          this.gameState = 'running';
        },

        stop() {
          this.gameState = 'stopped';
          // (Optionally emit end-game summary)
        },

        approveRequest(id) {
          const rid = this.roomId.trim().toUpperCase();
          this.socket.emit('approve-ticket', { roomId: rid, requestId: id, approved: true });
          this.ticketRequests = this.ticketRequests.filter(r => r.requestId !== id);
        },
        rejectRequest(id) {
          const rid = this.roomId.trim().toUpperCase();
          this.socket.emit('approve-ticket', { roomId: rid, requestId: id, approved: false });
          this.ticketRequests = this.ticketRequests.filter(r => r.requestId !== id);
        },

        approveClaim(id) {
          const rid = this.roomId.trim().toUpperCase();
          this.socket.emit('verify-claim', { roomId: rid, claimId: id, approved: true });
          this.prizeClaims = this.prizeClaims.filter(c => c.claimId !== id);
        },
        rejectClaim(id) {
          const rid = this.roomId.trim().toUpperCase();
          this.socket.emit('verify-claim', { roomId: rid, claimId: id, approved: false });
          this.prizeClaims = this.prizeClaims.filter(c => c.claimId !== id);
        },

        toggleNumber(n) {
          if (this.called.includes(n)) {
            this.called = this.called.filter(x => x !== n);
          } else {
            this.called.push(n);
          }
        },

        generateQR() {
          new QRious({
            element: this.$refs.qrCanvas,
            value: `${window.location.origin}?roomId=${this.roomId}`,
            size: 128
          });
        }
      }
    }
  </script>
</body>
</html>
