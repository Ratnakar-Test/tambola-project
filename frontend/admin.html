<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* ... (keep existing styles) ... */
    </style>
</head>
<body x-data="adminDashboard()" x-init="init()" class="bg-base-200 min-h-screen">
    <script>
function adminDashboard() {
    return {
        // ... (keep existing state properties) ...

        socket: null,

        init() {
            this.adminName = localStorage.getItem('tambolaAdminName') || '';
            this.roomIdToJoin = new URLSearchParams(window.location.search).get('roomIdToJoin') || '';

            console.log("Initializing admin dashboard..."); // Log init start

            const socketUrl = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
                              ? "http://localhost:3000"
                              : 'https://tambola-backend.onrender.com'; // Replace if needed
            console.log(`Attempting to connect to Socket.IO server at: ${socketUrl}`);
            this.socket = io(socketUrl, {
                // transports: ['websocket', 'polling'] // Optional
            });

            this.socket.on('connect', () => {
                console.log(`Admin Socket connected successfully! ID: ${this.socket.id}`);
                this.addNotification('Connected to server.', 'success');
                this.errorMsg = ''; // Clear connection errors
                // Attempt to rejoin if admin was previously connected to a room
                // This needs server-side support ('join-room' with isAdmin flag)
                // if (this.roomId && this.adminName && !this.connected) { // Check if we have room info but aren't 'connected'
                //    console.log(`Attempting to rejoin room ${this.roomId} as admin ${this.adminName}`);
                //    this.joinRoom(this.roomId); // Modify joinRoom to take roomId parameter if needed
                // }
            });

            this.socket.on('connect_error', (err) => {
                console.error('Admin Socket Connection Error:', err);
                this.errorMsg = `Connection Error: ${err.message}. Server may be down or unreachable.`;
                this.connected = false; // Ensure state reflects disconnection
                this.addNotification('Connection failed. Check server & refresh.', 'error', 10000);
            });

            this.socket.on('disconnect', (reason) => {
                console.error(`Admin Socket disconnected. Reason: "${reason}"`);
                this.addNotification(`Disconnected: ${reason}. Attempting reconnect...`, 'error');
                // Decide how to handle admin disconnect. Should they be logged out?
                // Resetting state might be necessary if rejoin isn't seamless.
                // this.connected = false;
                // this.roomId = '';
                // Resetting other game state might be needed depending on app flow
            });

            // ... (keep existing application-specific event handlers like 'room-created', 'admin-rejoined', 'player-joined', etc.) ...
            
            this.socket.on('room-created', data => {
                 console.log('Event received: room-created', data);
                 // ... (existing logic) ...
                 this.roomId = data.roomId;
                 this.connected = true;
                 this.adminName = data.adminName;
                 localStorage.setItem('tambolaAdminName', this.adminName);
                 this.generateQR();
                 this.addNotification(`Room ${data.roomId} created! Share QR/ID.`, 'success');
                 if(data.rules) this.rules = data.rules;
                 if(data.maxPrizes) this.maxPrizes = data.maxPrizes;
                 if(data.maxTicketsPerPlayer) this.maxTicketsPerPlayer = data.maxTicketsPerPlayer;
            });

             this.socket.on('admin-rejoined', data => {
                 console.log('Event received: admin-rejoined', data);
                 // ... (existing logic to update state) ...
                 this.roomId = data.roomId;
                 this.adminName = data.adminName;
                 this.connected = true;
                 this.gameState = data.gameState.state;
                 this.calledNumbers = data.gameState.calledNumbers || [];
                 this.players = data.players || [];
                 this.ticketRequests = data.ticketRequests || [];
                 this.prizeClaims = data.prizeClaims || [];
                 this.winners = data.gameState.winners || [];
                 this.rules = data.gameState.rules;
                 this.maxPrizes = data.gameState.maxPrizes;
                 this.gameMode = data.gameState.mode;
                 this.autoCallInterval = data.gameState.interval;
                 this.maxTicketsPerPlayer = data.maxTicketsPerPlayer;
                 this.generateQR();
                 this.addNotification(`Rejoined Room: ${this.roomId}.`, 'success');
            });
            
            // ... other handlers ...

             this.socket.on('room-error', data => {
                console.error('Room Error from Server:', data.error);
                this.errorMsg = data.error;
                this.addNotification(data.error, 'error');
            });
             this.socket.on('admin-error', data => { // Specific admin errors
                console.error('Admin Operation Error from Server:', data.error);
                this.errorMsg = data.error;
                 this.addNotification(data.error, 'error');
            });
             this.socket.on('server-error', data => {
                console.error('Generic Server Error:', data.message);
                this.errorMsg = data.message;
                this.addNotification(data.message, 'error');
            });


        }, // End init()

        // ... (keep existing methods like createRoom, joinRoom, startGame, etc.) ...

        addNotification(text, type = 'info', duration = 5000) {
            const id = Date.now();
             if (!this.notifications.some(n => n.text === text && n.type === type)) {
                 this.notifications.push({ id, text, type });
                 setTimeout(() => { this.removeNotification(id); }, duration);
             }
        },
        removeNotification(id) {
             this.notifications = this.notifications.filter(n => n.id !== id);
        },

        // ... (keep other methods) ...

    } // End return
} // End adminDashboard()
</script>
</body>
</html>
