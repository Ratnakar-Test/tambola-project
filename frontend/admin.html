<!-- File: tambola-project/frontend/admin.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- BLOCK 1: HEAD (Imports & Metadata) -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tambola Admin Dashboard</title>
  <!-- DaisyUI (includes Tailwind) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" />
  <!-- Tailwind “browser” build -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Alpine.js for reactivity -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- x-data Alpine component -->
  <div x-data="adminDashboard()" x-init="init()" class="relative">

    <!-- BLOCK 2: SETUP SCREEN -->
    <div x-show="!connected" class="flex flex-col items-center justify-center min-h-screen p-4">
      <h1 class="text-4xl font-bold mb-6">Tambola Admin Setup</h1>
      <input x-model="adminName" type="text" placeholder="Your Name"
             class="mb-4 p-2 border rounded w-64" />
      <input x-model.number="maxTickets" type="number" min="1" placeholder="Max Tickets per Player"
             class="mb-6 p-2 border rounded w-64" />
      <div class="space-x-4">
        <button @click="createRoom()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Create Room
        </button>
        <button @click="joinRoom()" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Join Room
        </button>
      </div>
      <template x-if="errorMsg">
        <div class="mt-4 text-red-600" x-text="errorMsg"></div>
      </template>
    </div>

    <!-- BLOCK 3: DRAWER LAYOUT (Main UI) -->
    <div x-show="connected" class="drawer">
      <input id="sidebar-toggle" type="checkbox" class="drawer-toggle" x-ref="sidebarToggle" />

      <!-- DRAWER CONTENT -->
      <div class="drawer-content flex flex-col">

        <!-- HEADER -->
        <header class="flex items-center p-4 bg-white shadow">
          <label for="sidebar-toggle" class="btn btn-ghost btn-square mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </label>
          <h1 class="text-2xl font-semibold flex-1">Room: <span x-text="roomId" class="font-mono"></span></h1>
          <button @click="callNumber()"
                  class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
            Call Number
          </button>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 pb-24 overflow-auto">

          <!-- SECTION: Numbers Grid -->
          <section x-show="currentTab==='Numbers'">
            <h2 class="text-xl font-semibold mb-2">Number Grid</h2>
            <div class="grid grid-cols-5 sm:grid-cols-7 md:grid-cols-10 gap-2 p-2 bg-white rounded-lg shadow-inner">
              <template x-for="n in 90" :key="n">
                <div class="stat stat-compact p-2 cursor-pointer rounded border transition-colors"
                     :class="called.includes(n)
                       ? 'bg-primary text-primary-content'
                       : 'bg-base-100 hover:bg-base-200'"
                     @click="toggleNumber(n)">
                  <div class="stat-value text-xs font-normal text-center w-full" x-text="n"></div>
                </div>
              </template>
            </div>
          </section>

          <!-- SECTION: Players List -->
          <section x-show="currentTab==='Players'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Players</h2>
            <ul class="list-disc list-inside bg-white p-4 rounded-lg shadow-inner">
              <template x-for="p in players" :key="p">
                <li x-text="p"></li>
              </template>
            </ul>
          </section>

          <!-- SECTION: Ticket Requests -->
          <section x-show="currentTab==='Ticket Requests'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Ticket Requests</h2>
            <ul class="bg-white p-4 rounded-lg shadow-inner space-y-2">
              <template x-for="req in ticketRequests" :key="req.requestId">
                <li class="flex justify-between items-center">
                  <span x-text="req.playerName"></span>
                  <div class="flex gap-2">
                    <button class="btn btn-sm btn-success" @click="approveRequest(req.requestId)">Approve</button>
                    <button class="btn btn-sm btn-error"   @click="rejectRequest(req.requestId)">Reject</button>
                  </div>
                </li>
              </template>
            </ul>
          </section>

          <!-- SECTION: Prize Claims -->
          <section x-show="currentTab==='Prize Claims'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Prize Claims</h2>
            <ul class="bg-white p-4 rounded-lg shadow-inner space-y-2">
              <template x-for="c in prizeClaims" :key="c.claimId">
                <li class="flex justify-between items-center">
                  <span x-text="c.playerName + ' → ' + c.claimType"></span>
                  <div class="flex gap-2">
                    <button class="btn btn-sm btn-success" @click="approveClaim(c.claimId)">Accept</button>
                    <button class="btn btn-sm btn-error"   @click="rejectClaim(c.claimId)">Reject</button>
                  </div>
                </li>
              </template>
            </ul>
          </section>

          <!-- SECTION: Winners -->
          <section x-show="currentTab==='Winners'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Winners</h2>
            <ul class="bg-white p-4 rounded-lg shadow-inner space-y-2">
              <template x-for="w in winners" :key="w.claimId">
                <li x-text="w.playerName + ' → ' + w.claimType"></li>
              </template>
            </ul>
          </section>

          <!-- SECTION: Winning Rules -->
          <section x-show="currentTab==='Rules'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Winning Rules</h2>
            <form class="bg-white p-4 rounded-lg shadow-inner space-y-3">
              <template x-for="r in ruleTypes" :key="r.key">
                <div class="flex items-center">
                  <input type="checkbox" class="toggle toggle-primary mr-2" x-model="r.enabled" />
                  <span class="flex-1" x-text="r.label"></span>
                  <input type="number" class="input input-bordered w-20 ml-2" min="1" x-model.number="r.max" />
                </div>
              </template>
            </form>
          </section>

          <!-- SECTION: QR Code -->
          <section x-show="currentTab==='QR Code'" class="mt-6">
            <h2 class="text-xl font-semibold mb-2">Room QR Code</h2>
            <div class="bg-white p-8 rounded-lg shadow-inner flex items-center justify-center">
              <!-- Placeholder for QR code image -->
              <span class="text-gray-500">QR CODE</span>
            </div>
          </section>

        </main>

        <!-- BLOCK 4: BOTTOM NAVIGATION -->
        <nav class="fixed bottom-0 left-0 w-full bg-white border-t shadow-lg p-2 flex flex-wrap justify-around items-center z-50">
          <button class="btn btn-primary flex-1 m-1" @click="start()">Start</button>
          <button class="btn btn-warning flex-1 m-1" @click="pause()">Pause</button>
          <button class="btn btn-error flex-1 m-1"   @click="stop()">Stop</button>
          <div class="flex-1 m-1">
            <select class="select select-bordered w-full" x-model="mode">
              <option>Manual</option>
              <option>Auto</option>
            </select>
          </div>
          <div class="flex-1 m-1">
            <select class="select select-bordered w-full" x-model.number="interval">
              <option>3</option><option>5</option><option>7</option>
            </select>
          </div>
        </nav>

      </div>

      <!-- BLOCK 5: SIDEBAR -->
      <div class="drawer-side">
        <label for="sidebar-toggle" class="drawer-overlay"></label>
        <aside class="p-6 w-64 bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-xl">
          <h2 class="text-2xl font-bold mb-4">🎉 Tambola</h2>
          <ul class="space-y-2">
            <li>
              <a href="#" @click.prevent="currentTab='Numbers'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Numbers'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Numbers
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='Players'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Players'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Players
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='Ticket Requests'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Ticket Requests'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Ticket Requests
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='Prize Claims'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Prize Claims'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Prize Claims
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='Winners'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Winners'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Winners
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='Rules'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='Rules'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                Rules
              </a>
            </li>
            <li>
              <a href="#" @click.prevent="currentTab='QR Code'; $refs.sidebarToggle.checked=false"
                 :class="currentTab==='QR Code'? 'bg-blue-700 font-semibold':''"
                 class="block py-2 px-4 rounded hover:bg-blue-500">
                QR Code
              </a>
            </li>
          </ul>
        </aside>
      </div>
    </div>
  </div>

  <!-- BLOCK 6: Alpine Component Script -->
  <script>
    function adminDashboard() {
      return {
        // ----- STATE -----
        connected: false,
        roomId: '',
        adminName: '',
        maxTickets: 5,
        errorMsg: '',

        currentTab: 'Numbers',
        called: [],
        players: [],
        ticketRequests: [],
        prizeClaims: [],
        winners: [],
        ruleTypes: [
          { key: 'topLine',   label: 'Top Line',   enabled: true, max: 1 },
          { key: 'twoLines',  label: 'Two Lines',  enabled: true, max: 1 },
          { key: 'fullHouse', label: 'Full House', enabled: true, max: 1 },
        ],
        mode: 'Manual',
        interval: 3,

        // ----- INITIALIZER -----
        init() {
          this.socket = io();

          // Server → Client events
          this.socket.on('room-created', data => {
            this.roomId = data.roomId;
            this.connected = true;
          });
          this.socket.on('player-joined', data => {
            this.players = data.players;
          });
          this.socket.on('number-called', data => {
            this.called = data.calledNumbers;
          });
          this.socket.on('ticket-requested', data => {
            this.ticketRequests.push({ requestId: data.requestId, playerName: data.playerName });
          });
          this.socket.on('ticket-updated', data => {
            // no-op for admin
          });
          this.socket.on('claim-submitted', data => {
            this.prizeClaims.push({ claimId: data.claimId, playerName: data.playerName, claimType: data.claimType });
          });
          this.socket.on('claim-updated', data => {
            this.winners.push({ playerName: data.playerName, claimType: data.claimType, claimId: data.claimId });
          });
        },

        // ----- ACTIONS -----
        createRoom() {
          this.errorMsg = '';
          if (!this.adminName) return this.errorMsg = 'Enter your name';
          this.socket.emit('create-room',
            { adminName: this.adminName, maxTicketsPerPlayer: this.maxTickets },
            res => {
              if (!res.success) this.errorMsg = res.error;
            }
          );
        },
        joinRoom() {
          this.errorMsg = '';
          if (!this.adminName || !this.roomId) return this.errorMsg = 'Name & Room ID required';
          this.socket.emit('join-room',
            { roomId: this.roomId, playerName: this.adminName },
            res => {
              if (res.success) this.connected = true;
              else this.errorMsg = res.error;
            }
          );
        },
        callNumber() {
          this.socket.emit('call-number', { roomId: this.roomId }, res => {
            if (!res.success) alert(res.error);
          });
        },
        approveRequest(id) {
          this.socket.emit('approve-ticket', { roomId: this.roomId, requestId: id, approved: true });
          this.ticketRequests = this.ticketRequests.filter(r => r.requestId !== id);
        },
        rejectRequest(id) {
          this.socket.emit('approve-ticket', { roomId: this.roomId, requestId: id, approved: false });
          this.ticketRequests = this.ticketRequests.filter(r => r.requestId !== id);
        },
        approveClaim(id) {
          this.socket.emit('verify-claim', { roomId: this.roomId, claimId: id, approved: true });
          this.prizeClaims = this.prizeClaims.filter(c => c.claimId !== id);
        },
        rejectClaim(id) {
          this.socket.emit('verify-claim', { roomId: this.roomId, claimId: id, approved: false });
          this.prizeClaims = this.prizeClaims.filter(c => c.claimId !== id);
        },
        toggleNumber(n) {
          // manual highlight
          if (this.called.includes(n)) this.called = this.called.filter(x => x !== n);
          else this.called.push(n);
        },

        start() {
          if (this.mode === 'Auto') {
            this.autoInterval = setInterval(() => this.callNumber(), this.interval * 1000);
          } else {
            this.callNumber();
          }
        },
        pause() {
          clearInterval(this.autoInterval);
        },
        stop() {
          clearInterval(this.autoInterval);
          this.called = [];
          this.winners = [];
        }
      };
    }
  </script>

</body>
</html>
