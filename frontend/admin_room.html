<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin - Game Room</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-bottom: 160px; /* For bottom nav */
        }
        .flex-grow { flex-grow: 1; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .drawer-side > *:not(label) { overflow-y: auto; }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            max-width: 800px;
            margin: auto;
        }
        .number-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, transform 0.3s, box-shadow 0.3s;
        }
        .number-cell.called {
            background-color: oklch(var(--p));
            color: oklch(var(--pc));
            transform: scale(1.1);
            box-shadow: 0 0 10px oklch(var(--p));
        }
        .number-cell.latest { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { transform: scale(1.1); box-shadow: 0 0 10px oklch(var(--p)); }
            50% { transform: scale(1.25); box-shadow: 0 0 18px oklch(var(--p)); }
            100% { transform: scale(1.1); box-shadow: 0 0 10px oklch(var(--p)); }
        }
        .bottom-nav-controls-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: oklch(var(--b1));
            padding: 0.5rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 45; display: flex; flex-direction: column; gap: 0.5rem;
        }
        .control-bar {
            display: flex; flex-wrap: wrap; gap: 0.5rem;
            align-items: center; justify-content: space-around;
            width: 100%; padding: 0.25rem 0;
        }
        .control-bar:not(:last-child) {
            border-bottom: 1px solid oklch(var(--b3));
            padding-bottom: 0.75rem; margin-bottom: 0.25rem;
        }
        .game-message-popup {
            position: fixed;
            top: 80px; /* Below navbar */
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.875rem; /* text-sm */
            z-index: 1000; /* High z-index */
            max-width: 300px;
            word-wrap: break-word;
        }
    </style>
</head>
<body x-data="adminRoom()">
    <div class="drawer lg:drawer-open">
        <input id="my-drawer" type="checkbox" class="drawer-toggle" x-model="isDrawerOpen" />
        <div class="drawer-content flex flex-col bg-base-200">
            <nav class="navbar bg-base-100 shadow-lg sticky top-0 z-30">
                <div class="flex-none">
                    <label for="my-drawer" class="btn btn-square btn-ghost lg:hidden" aria-label="Open menu">
                        <i class="fas fa-bars text-xl"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <a class="btn btn-ghost normal-case text-xl">Tambola Admin Panel</a>
                </div>
                <div class="flex-none">
                     <span class="mr-2 hidden sm:inline">Room ID: <strong x-text="roomId"></strong></span>

                    <div class="dropdown dropdown-end ml-2">
                        <label tabindex="0" class="btn btn-ghost btn-circle indicator">
                            <i class="fas fa-bell text-xl"></i>
                            <template x-if="notifications.length > 0">
                                <span class="indicator-item badge badge-secondary badge-sm" x-text="notifications.length"></span>
                            </template>
                        </label>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[50] p-2 shadow bg-base-100 rounded-box w-64 sm:w-80 max-h-96 overflow-y-auto">
                            <template x-if="notifications.length === 0">
                                <li class="p-2 text-center text-sm text-base-content/70">No new notifications</li>
                            </template>
                            <template x-for="notification in notifications" :key="notification.id">
                                <li>
                                    <a @click="handleNotificationClick(notification)" class="whitespace-normal text-xs p-2 hover:bg-base-200">
                                        <div class="flex flex-col w-full">
                                            <div class="font-semibold" x-text="notification.type"></div>
                                            <div class="text-base-content/80" x-text="notification.message"></div>
                                            <div class="text-xs opacity-60 mt-1 self-end" x-text="new Date(notification.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })"></div>
                                        </div>
                                    </a>
                                </li>
                            </template>
                            <template x-if="notifications.length > 0">
                                <div class="divider my-1"></div>
                                <li><a @click="clearAllNotifications()" class="text-xs text-center text-error p-2 hover:bg-error hover:text-error-content">Clear All</a></li>
                            </template>
                        </ul>
                    </div>

                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-circle" aria-label="Theme selector">
                            <i class="fas fa-palette"></i>
                        </label>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[50] p-2 shadow bg-base-100 rounded-box w-52">
                            <template x-for="theme in themes" :key="theme">
                                <li><a @click="setTheme(theme, $event)" x-text="theme.charAt(0).toUpperCase() + theme.slice(1)"></a></li>
                            </template>
                        </ul>
                    </div>
                </div>
            </nav>

            <main class="flex-grow p-4 overflow-y-auto">
                <div x-show="currentView === 'home'" x-transition>
                    <h2 class="text-2xl font-bold mb-1">Game Room (<span x-text="adminName"></span>)</h2>
                    <div class="mb-3 text-center">Status: <span class="badge badge-lg"
                        :class="{
                            'badge-neutral': gameStatus === 'idle' || gameStatus === 'connecting' || gameStatus === 'disconnected',
                            'badge-success': gameStatus === 'running',
                            'badge-warning': gameStatus === 'paused',
                            'badge-error': gameStatus === 'stopped' || gameStatus === 'error'
                        }"
                        x-text="gameStatus"></span>
                    </div>

                    <div class="text-center my-6" x-show="latestCalledNumber !== null">
                        <span class="label-text">Last Called:</span>
                        <div class="badge badge-lg badge-secondary text-2xl p-4" x-text="latestCalledNumber"></div>
                    </div>
                    <div class="text-center my-6" x-show="latestCalledNumber === null && gameStatus === 'running'">
                        <span class="label-text">Game started. Call the first number!</span>
                    </div>

                    <div class="number-grid p-2 bg-base-100 rounded-lg shadow">
                        <template x-for="numObj in numbers" :key="numObj.number">
                            <div class="number-cell bg-base-300" :class="{ 'called': numObj.called, 'latest': numObj.number === latestCalledNumber && numObj.called }" x-text="numObj.number"></div>
                        </template>
                    </div>
                </div>

                <div x-show="currentView === 'players'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Players (<span x-text="players.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead><tr><th>Name</th><th>ID</th><th class="text-center">Tickets</th></tr></thead>
                            <tbody>
                                <template x-if="players.length === 0"><tr><td colspan="3" class="text-center italic py-4">No players connected yet.</td></tr></template>
                                <template x-for="player in players" :key="player.id">
                                    <tr>
                                        <td x-text="player.name"></td>
                                        <td x-text="player.id" class="text-xs"></td>
                                        <td x-text="player.ticketCount" class="text-center"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'ticketRequests'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Pending Ticket Requests (<span x-text="pendingTicketRequests.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th class="text-center">Current Tickets</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="pendingTicketRequests.length === 0">
                                    <tr><td colspan="3" class="text-center italic py-4">No pending ticket requests.</td></tr>
                                </template>
                                <template x-for="request in pendingTicketRequests" :key="request.playerId">
                                    <tr>
                                        <td>
                                            <div class="font-bold" x-text="request.playerName"></div>
                                            <div class="text-xs opacity-70" x-text="'ID: ' + request.playerId.substring(0,6)"></div>
                                        </td>
                                        <td class="text-center" x-text="request.currentTickets"></td>
                                        <td class="text-center">
                                            <div class="flex flex-col sm:flex-row gap-1 justify-center items-center">
                                                <button class="btn btn-xs btn-success w-full sm:w-auto" @click="approveTicketRequest(request.playerId)">Approve</button>
                                                <button class="btn btn-xs btn-error w-full sm:w-auto mt-1 sm:mt-0" @click="rejectTicketRequest(request.playerId, 'Admin rejected')">Reject</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'prizeClaims'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Pending Prize Claims (<span x-text="pendingPrizeClaims.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Prize Claimed</th>
                                    <th>Ticket ID</th>
                                    <th class="text-center">Server Valid?</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="pendingPrizeClaims.length === 0">
                                    <tr><td colspan="5" class="text-center italic py-4">No pending prize claims.</td></tr>
                                </template>
                                <template x-for="claim in pendingPrizeClaims" :key="claim.claimId">
                                    <tr>
                                        <td>
                                            <div class="font-bold" x-text="claim.playerName"></div>
                                            <div class="text-xs opacity-70" x-text="'ID: ' + claim.playerId.substring(0,6)"></div>
                                        </td>
                                        <td>
                                            <div x-text="claim.prizeName"></div>
                                            <div class="text-xs opacity-70" x-text="'Rule: ' + claim.prizeRuleId"></div>
                                        </td>
                                        <td class="text-xs" x-text="claim.ticketId ? claim.ticketId.substring(0,10) + '...' : 'N/A'"></td>
                                        <td class="text-center">
                                            <span class="badge badge-sm"
                                                  :class="{'badge-success': claim.serverValidationResult, 'badge-warning': !claim.serverValidationResult}"
                                                  x-text="claim.serverValidationResult ? 'Yes' : 'No (Verify)'">
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <div class="flex flex-col sm:flex-row gap-1 justify-center items-center">
                                                <button class="btn btn-xs btn-success w-full sm:w-auto" @click="approvePrizeClaim(claim)">Approve</button>
                                                <button class="btn btn-xs btn-error w-full sm:w-auto mt-1 sm:mt-0" @click="rejectPrizeClaim(claim, 'Did not meet criteria')">Reject</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'winners'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Winners (<span x-text="winners.length"></span>)</h2>
                     <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead><tr><th>Player</th><th>Prize</th><th>Rule ID</th><th>Value</th><th>Time</th></tr></thead>
                            <tbody>
                                <template x-if="winners.length === 0"><tr><td colspan="5" class="text-center italic py-4">No winners yet.</td></tr></template>
                                <template x-for="winner in winners" :key="winner.claimId">
                                    <tr>
                                        <td x-text="winner.playerName"></td>
                                        <td x-text="winner.prizeName"></td>
                                        <td x-text="winner.prizeRuleId" class="text-xs"></td>
                                        <td x-text="winner.coins.toFixed(2)"></td>
                                        <td x-text="new Date(winner.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'rules'" x-transition class="space-y-6">
                     <h2 class="text-2xl font-bold mb-4">Game Rules & Prize Allocation</h2>
                    <div class="bg-base-100 p-4 rounded-lg shadow">
                        <p class="text-sm mb-4">
                            Activate rules, assign their percentage share (Base Weight) of the total prize pool, and set max prizes.
                            The sum of Base Weights for active rules will always be 100%. Value per prize is auto-calculated based on the 'Total Money Collected'.
                        </p>
                    </div>
                    <template x-for="(rule, index) in gameRules" :key="rule.id">
                        <div class="card bg-base-100 shadow-md">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="card-title text-lg" x-text="rule.name"></h3>
                                    <input type="checkbox" class="toggle toggle-primary" x-model="rule.isActive" @change="handleActivationToggle(rule.id)" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                </div>
                                <p class="text-xs text-base-content/70 mt-1" x-text="rule.description"></p>
                                <div x-show="rule.isActive" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Base Weight (%)</span></label>
                                        <input type="number" class="input input-sm input-bordered" :value="rule.baseWeight ? rule.baseWeight.toFixed(2) : '0.00'" @input="handleBaseWeightInput(rule.id, $event.target.value)" min="0" max="100" step="0.01" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                    </div>
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Max Prizes Allowed</span></label>
                                        <input type="number" class="input input-sm input-bordered" x-model.number="rule.maxPrizes" min="1" @input="updateRuleCalculations()" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                    </div>
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Value per Prize</span></label>
                                        <span class="input input-sm input-bordered flex items-center bg-base-200" x-text="rule.coinsPerPrize > 0 ? rule.coinsPerPrize.toFixed(2) : '0.00'"></span>
                                    </div>
                                </div>
                                <div x-show="rule.isActive" class="mt-2 text-sm">Allocated Prize Pool Share: <span class="font-semibold" x-text="rule.baseWeight ? rule.baseWeight.toFixed(2) + '%' : '0.00%'"></span></div>
                            </div>
                        </div>
                    </template>
                    <div class="bg-base-100 p-4 rounded-lg shadow mt-6 space-y-3">
                        <h3 class="text-xl font-semibold">Prize Allocation & Financial Summary</h3>
                        <div class="form-control">
                            <label class="label"><span class="label-text">Total Money Collected (e.g., Currency Units)</span></label>
                            <input type="number" placeholder="Enter amount" class="input input-bordered" x-model.number="totalMoneyCollected" @input="updateRuleCalculations()" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        </div>
                        <p>Total Selected Weight (Active Rules): <strong x-text="totalSelectedWeight.toFixed(0) + '%'"></strong></p>
                        <p>Total Value of Prizes to be Distributed: <strong x-text="totalPotentialPrizeValue.toFixed(2)"></strong></p>
                        <button class="btn btn-primary btn-sm mt-2" @click="saveRulesConfiguration" :disabled="gameStatus === 'running' || gameStatus === 'paused'">Save Rules & Financials</button>
                         <p x-show="gameStatus === 'running' || gameStatus === 'paused'" class="text-xs text-warning">Rules and financials cannot be saved while game is in progress.</p>
                    </div>
                </div>

                <div x-show="currentView === 'qrCode'" x-transition class="text-center">
                    <h2 class="text-2xl font-bold mb-4">Player Join QR Code</h2>
                    <p class="mb-4">Players can scan this QR code to join Room ID: <strong x-text="roomId"></strong></p>
                    <div class="flex justify-center"><div id="qrcodeCanvas" class="bg-white p-4 inline-block rounded-lg shadow-lg"></div></div>
                    <button class="btn btn-secondary mt-4" @click="generateQRCode"><i class="fas fa-sync-alt mr-2"></i>Regenerate QR Code</button>
                </div>

                <div x-show="currentView === 'gameSummary'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Game Summary</h2>
                    <div x-show="!gameSummaryData || Object.keys(gameSummaryData).length === 0" class="text-center italic p-4 bg-base-100 rounded-lg shadow">
                        Game summary will be available after the game ends or if loaded.
                    </div>
                    <div x-show="gameSummaryData && Object.keys(gameSummaryData).length > 0" class="bg-base-100 p-4 rounded-lg shadow space-y-3">
                        <p>Total Numbers Called: <strong x-text="gameSummaryData.totalNumbersCalled !== undefined ? gameSummaryData.totalNumbersCalled : 'N/A'"></strong></p>
                        <h3 class="text-lg font-semibold mt-4 mb-2">Winners:</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-sm table-zebra w-full">
                                <thead><tr><th>Player</th><th>Prize</th><th>Value</th></tr></thead>
                                <tbody>
                                    <template x-if="!gameSummaryData.winners || gameSummaryData.winners.length === 0"><tr><td colspan="3" class="text-center">No winners in this game.</td></tr></template>
                                    <template x-for="winner in gameSummaryData.winners" :key="winner.claimId">
                                        <tr>
                                            <td x-text="winner.playerName"></td>
                                            <td x-text="winner.prizeName"></td>
                                            <td x-text="winner.coins.toFixed(2)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                         <h3 class="text-lg font-semibold mt-4 mb-2">Player Details:</h3>
                         <div class="overflow-x-auto">
                            <table class="table table-sm table-zebra w-full">
                                <thead><tr><th>Player</th><th>Tickets</th><th>Total Value Won</th></tr></thead>
                                <tbody>
                                    <template x-if="!gameSummaryData.players || gameSummaryData.players.length === 0"><tr><td colspan="3" class="text-center">No player data in summary.</td></tr></template>
                                    <template x-for="player in gameSummaryData.players" :key="player.name">
                                        <tr>
                                            <td x-text="player.name"></td>
                                            <td x-text="player.tickets" class="text-center"></td>
                                            <td x-text="player.coins ? player.coins.toFixed(2) : '0.00'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <div x-show="gameMessage" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2"
                     class="game-message-popup"
                     :class="{ 'bg-error text-error-content': gameMessageType === 'error',
                               'bg-warning text-warning-content': gameMessageType === 'warning',
                               'bg-info text-info-content': gameMessageType === 'info',
                               'bg-success text-success-content': gameMessageType === 'success' }"
                     x-text="gameMessage">
                </div>
            </main>
        </div>

        <div class="drawer-side z-40">
            <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <ul class="menu p-4 w-80 min-h-full bg-base-100 text-base-content">
                <li class="mb-2 text-center"><span class="text-lg font-bold">Admin Menu</span><button @click="isDrawerOpen = false" class="btn btn-ghost btn-sm btn-circle absolute top-2 right-2 lg:hidden">✕</button></li>
                <li><a @click="changeView('home')" :class="{ 'active': currentView === 'home' }"><i class="fas fa-dice-d20 mr-2"></i>Game Board</a></li>
                <li><a @click="changeView('rules')" :class="{ 'active': currentView === 'rules' }"><i class="fas fa-gavel mr-2"></i>Rules & Prizes</a></li>
                <li><a @click="changeView('players')" :class="{ 'active': currentView === 'players' }"><i class="fas fa-users mr-2"></i>Players</a></li>
                <li><a @click="changeView('ticketRequests')" :class="{ 'active': currentView === 'ticketRequests' }"><i class="fas fa-ticket-alt mr-2"></i>Ticket Requests</a></li>
                <li><a @click="changeView('prizeClaims')" :class="{ 'active': currentView === 'prizeClaims' }"><i class="fas fa-trophy mr-2"></i>Prize Claims</a></li>
                <li><a @click="changeView('winners')" :class="{ 'active': currentView === 'winners' }"><i class="fas fa-medal mr-2"></i>Winners</a></li>
                <li><a @click="changeView('qrCode')" :class="{ 'active': currentView === 'qrCode' }"><i class="fas fa-qrcode mr-2"></i>QR Code</a></li>
                <li><a @click="changeView('gameSummary')" :class="{ 'active': currentView === 'gameSummary' }"><i class="fas fa-clipboard-list mr-2"></i>Game Summary</a></li>
                <li class="mt-auto"><a href="admin_join.html"><i class="fas fa-sign-out-alt mr-2"></i>Logout / New Room</a></li>
            </ul>
        </div>
    </div>

    <div class="bottom-nav-controls-container" x-show="currentView === 'home'">
        <div class="control-bar">
            <div class="form-control">
                <label class="label cursor-pointer">
                    <span class="label-text mr-1 sm:mr-2">Mode:</span>
                    <select class="select select-bordered select-xs sm:select-sm" x-model="callingMode" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        <option value="manual">Manual</option>
                        <option value="auto">Auto</option>
                    </select>
                </label>
            </div>
            <div class="form-control" x-show="callingMode === 'auto'">
                <label class="label cursor-pointer">
                    <span class="label-text mr-1 sm:mr-2">Interval:</span>
                    <select class="select select-bordered select-xs sm:select-sm" x-model.number="autoCallInterval" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        <option value="3">3s</option>
                        <option value="5">5s</option>
                        <option value="7">7s</option>
                        <option value="10">10s</option>
                    </select>
                </label>
            </div>
            <button class="btn btn-success btn-xs sm:btn-sm" @click="startGame" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                <i class="fas fa-play mr-1"></i> Start Game
            </button>
        </div>
        <div class="control-bar">
            <button class="btn btn-primary btn-xs sm:btn-sm" @click="callNextNumber" :disabled="callingMode !== 'manual' || gameStatus !== 'running'">
                <i class="fas fa-arrow-right mr-1"></i> Call Next
            </button>
            <button class="btn btn-warning btn-xs sm:btn-sm" @click="pauseGame" :disabled="callingMode !== 'auto' || gameStatus !== 'running'">
                <i class="fas fa-pause mr-1"></i> Pause Auto
            </button>
            <button class="btn btn-info btn-xs sm:btn-sm" @click="resumeGame" :disabled="callingMode !== 'auto' || gameStatus !== 'paused'">
                <i class="fas fa-play-circle mr-1"></i> Resume Auto
            </button>
            <button class="btn btn-error btn-xs sm:btn-sm" @click="stopGame" :disabled="gameStatus === 'idle' || gameStatus === 'stopped' || gameStatus === 'connecting'">
                <i class="fas fa-stop mr-1"></i> Stop Game
            </button>
        </div>
    </div>

    <script>
    function adminRoom() {
        return {
            // Core Properties
            adminName: '',
            roomId: '',
            socket: null,
            currentView: 'home',
            isDrawerOpen: false,
            themes: [
                "light", "dark", "cupcake", "bumblebee", "emerald", "corporate", "synthwave", "retro", "cyberpunk", "valentine", "halloween", "garden", "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe", "black", "luxury", "dracula", "cmyk", "autumn", "business", "acid", "lemonade", "night", "coffee", "winter"
            ],
            notifications: [],

            // Game State Properties
            numbers: Array.from({ length: 90 }, (_, i) => ({ number: i + 1, called: false })),
            calledNumbersHistory: [],
            latestCalledNumber: null,
            callingMode: 'manual',
            autoCallInterval: 5,
            gameStatus: 'connecting',

            // UI Messages
            gameMessage: '',
            gameMessageType: 'info',
            gameMessageTimeout: null,

            // Data Lists from Server
            players: [],
            pendingTicketRequests: [],
            pendingPrizeClaims: [],
            winners: [],
            gameSummaryData: {},

            // Rules and Financials
            gameRules: [
                { id: 'rule_early5', name: 'Early 5', description: 'First five numbers called on any ticket.', baseWeight: 10, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 10 },
                { id: 'rule_topline', name: 'Top Line', description: 'All numbers in the top row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15 },
                { id: 'rule_middleline', name: 'Middle Line', description: 'All numbers in the middle row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15 },
                { id: 'rule_bottomline', name: 'Bottom Line', description: 'All numbers in the bottom row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15 },
                { id: 'rule_corners', name: 'Corners', description: 'First and last actual numbers of top and bottom rows.', baseWeight: 10, maxPrizes: 2, coinsPerPrize: 0, isActive: false, originalWeight: 10 },
                { id: 'rule_fullhouse', name: 'Full House', description: 'All 15 numbers on the ticket.', baseWeight: 35, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 35 },
            ],
            totalSelectedWeight: 0,
            totalPotentialPrizeValue: 0,
            totalMoneyCollected: 0,

            init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme, null, false);

                const urlParams = new URLSearchParams(window.location.search);
                this.adminName = localStorage.getItem('adminName') || urlParams.get('adminName') || null;
                this.roomId = localStorage.getItem('roomId') || urlParams.get('roomId') || null;

                if (!this.roomId || !this.adminName) {
                    this.showGameMessage("Room ID or Admin Name missing. Please use the Admin Join page.", "error", null);
                    this.gameStatus = 'error';
                    return;
                }
                this.initializeClientStateForNewGame();

                this.gameRules.forEach(rule => {
                    if (rule.originalWeight === undefined) {
                        rule.originalWeight = rule.baseWeight !== undefined ? rule.baseWeight : (rule.isActive ? 10 : 0);
                    }
                    if (rule.baseWeight === undefined) { // Ensure baseWeight also has a default
                         rule.baseWeight = (rule.isActive ? 10 :0);
                    }
                    rule.isActive = !!rule.isActive;
                    rule.maxPrizes = parseInt(rule.maxPrizes) || 1;
                    rule.coinsPerPrize = parseFloat(rule.coinsPerPrize) || 0;
                });

                this.normalizeActiveRuleWeights();
                this.updateRuleCalculations();
                this.connectAdminWebSocket();
            },

            initializeClientStateForNewGame() {
                this.numbers = Array.from({ length: 90 }, (_, i) => ({ number: i + 1, called: false }));
                this.calledNumbersHistory = [];
                this.latestCalledNumber = null;
                this.winners = [];
                this.pendingPrizeClaims = [];
                this.pendingTicketRequests = [];
                this.gameSummaryData = {};
            },

            connectAdminWebSocket() {
                this.gameStatus = 'connecting';
                const socketURL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                    ? `ws://${window.location.hostname}:3000`
                    : `wss://tambola-backend.onrender.com`; // IMPORTANT: Replace

                this.socket = new WebSocket(socketURL);
                this.socket.onopen = () => {
                    this.showGameMessage('Connected to server.', 'success', 2000);
                    this.socket.send(JSON.stringify({ type: 'ADMIN_CREATE_JOIN_ROOM', payload: { adminName: this.adminName, roomId: this.roomId }}));
                };
                this.socket.onmessage = (event) => this.handleWebSocketMessage(JSON.parse(event.data));
                this.socket.onclose = (event) => { this.gameStatus = 'disconnected'; this.showGameMessage('Disconnected. Refresh to rejoin.', 'error', null); console.warn('Admin WS Closed:', event.reason);};
                this.socket.onerror = (error) => { this.gameStatus = 'error'; this.showGameMessage('WS connection error.', 'error', null); console.error('Admin WS Error:', error);};
            },

            handleWebSocketMessage(message) {
                const { type, payload } = message;
                console.log('Admin received WS:', type, payload);
                switch (type) {
                    case 'ROOM_JOIN_SUCCESS':
                        this.showGameMessage(`Connected to Room: ${payload.roomId} as Admin: ${payload.adminName}`, 'success');
                        this.gameStatus = payload.gameStatus || 'idle';
                        this.players = payload.players || [];
                        this.calledNumbersHistory = payload.calledNumbers || [];

                        if (payload.calledNumbers && payload.calledNumbers.length > 0) {
                            this.latestCalledNumber = payload.calledNumbers[payload.calledNumbers.length - 1];
                            payload.calledNumbers.forEach(num => { const nObj = this.numbers.find(n => n.number === num); if (nObj) nObj.called = true; });
                        } else {
                            this.numbers = Array.from({ length: 90 }, (_, i) => ({ number: i + 1, called: false }));
                            this.latestCalledNumber = null;
                        }

                        if (payload.rules && payload.rules.length > 0) {
                            this.gameRules = payload.rules.map(rule => ({
                                ...rule,
                                isActive: !!rule.isActive,
                                originalWeight: rule.originalWeight !== undefined ? rule.originalWeight : (rule.baseWeight !== undefined ? rule.baseWeight : (!!rule.isActive ? 10 : 0)),
                                baseWeight: rule.baseWeight !== undefined ? rule.baseWeight : (!!rule.isActive ? 10 : 0),
                                maxPrizes: parseInt(rule.maxPrizes) || 1,
                                coinsPerPrize: parseFloat(rule.coinsPerPrize) || 0
                            }));
                        } else {
                            this.gameRules.forEach(rule => {
                                if (rule.originalWeight === undefined) {
                                    rule.originalWeight = rule.baseWeight !== undefined ? rule.baseWeight : (rule.isActive ? 10 : 0);
                                }
                            });
                        }
                        this.normalizeActiveRuleWeights(); // Critical call after rules are set

                        this.totalMoneyCollected = payload.totalMoneyCollected !== undefined ? parseFloat(payload.totalMoneyCollected) : this.totalMoneyCollected;
                        this.callingMode = payload.callingMode || this.callingMode;
                        if (payload.winners) this.winners = payload.winners;

                        this.updateRuleCalculations(); // Critical call after normalization and money collected
                        break;
                    case 'NUMBER_CALLED':
                        this.latestCalledNumber = payload.number;
                        this.calledNumbersHistory = payload.calledNumbersHistory;
                        const numObj = this.numbers.find(n => n.number === payload.number); if (numObj) numObj.called = true;
                        break;
                    case 'GAME_STARTED':
                        this.gameStatus = 'running'; this.initializeClientStateForNewGame();
                        this.gameRules = payload.rules || this.gameRules; this.callingMode = payload.callingMode || this.callingMode;
                        this.totalMoneyCollected = payload.totalMoneyCollected !== undefined ? payload.totalMoneyCollected : this.totalMoneyCollected;
                         // Ensure rules from payload are properly initialized for calculation
                        this.gameRules.forEach(rule => {
                            if (rule.originalWeight === undefined) rule.originalWeight = rule.baseWeight !== undefined ? rule.baseWeight : (rule.isActive ? 10 : 0);
                            rule.isActive = !!rule.isActive;
                            rule.maxPrizes = parseInt(rule.maxPrizes) || 1;
                        });
                        this.normalizeActiveRuleWeights(); // Re-normalize with potentially new rules
                        this.updateRuleCalculations(); // Recalculate prizes
                        this.showGameMessage(`Game started! Mode: ${this.callingMode}.`, "success");
                        break;
                    case 'GAME_PAUSED': case 'GAME_RESUMED': case 'GAME_STOPPED':
                        this.gameStatus = payload.status; this.showGameMessage(`Game ${payload.status}.`, "info");
                        break;
                    case 'GAME_OVER_ALL_NUMBERS_CALLED':
                        this.gameStatus = 'stopped'; this.calledNumbersHistory = payload.finalCalledNumbers;
                        if (payload.finalCalledNumbers.length > 0) { this.latestCalledNumber = payload.finalCalledNumbers[payload.finalCalledNumbers.length-1]; payload.finalCalledNumbers.forEach(num => { const nObj = this.numbers.find(n => n.number === num); if (nObj) nObj.called = true; });}
                        this.showGameMessage("All numbers called! Game Over!", "success", null);
                        break;
                    case 'PLAYER_LIST_UPDATE': this.players = payload.players; break;
                    case 'ADMIN_TICKET_REQUEST_RECEIVED':
                        if (!this.pendingTicketRequests.find(req => req.playerId === payload.playerId)) this.pendingTicketRequests.push(payload);
                        this.addNotification('Ticket Request', `From: ${payload.playerName}`, 'ticketRequests', payload.playerId);
                        this.showGameMessage(`Ticket request from ${payload.playerName}.`, 'info', 5000);
                        break;
                    case 'ADMIN_PRIZE_CLAIM_RECEIVED':
                        if (!this.pendingPrizeClaims.find(claim => claim.claimId === payload.claimId)) this.pendingPrizeClaims.push(payload);
                        this.addNotification('Prize Claim', `From: ${payload.playerName} for ${payload.prizeName}`, 'prizeClaims', payload.claimId);
                        this.showGameMessage(`Prize claim from ${payload.playerName}.`, 'info', 5000);
                        break;
                    case 'WINNER_ANNOUNCEMENT':
                        if (!this.winners.find(w => w.claimId === payload.claimId)) {
                             this.winners.push({ claimId: payload.claimId, playerId: payload.playerId, playerName: payload.playerName, prizeName: payload.prizeName, prizeRuleId: payload.prizeRuleId, coins: payload.coins, timestamp: new Date().toISOString() });
                        }
                        this.pendingPrizeClaims = this.pendingPrizeClaims.filter(c => c.claimId !== payload.claimId);
                        this.addNotification('Winner Processed', `${payload.playerName} won ${payload.prizeName}`, 'winners', payload.claimId);
                        break;
                    case 'RULES_SAVE_CONFIRMED': this.showGameMessage(payload.message || "Rules updated on server.", "success"); break;
                    case 'ADMIN_ACTION_SUCCESS': this.showGameMessage(payload.message, 'success'); break;
                    case 'ADMIN_ACTION_FAIL': this.showGameMessage(payload.message, 'error', 5000); break;
                    case 'GAME_SUMMARY_BROADCAST': this.gameSummaryData = payload; this.currentView = 'gameSummary'; this.showGameMessage("Game ended. Summary received.", "info", null); break;
                    case 'ERROR': this.showGameMessage(`Server Error: ${payload.message}`, 'error', null); break;
                    case 'INFO': this.showGameMessage(`Server Info: ${payload.message}`, 'info'); break;
                }
            },

            // Notification System Methods
            addNotification(type, message, targetView, relatedId = null) {
                const newNotification = { id: Date.now() + Math.random(), type, message, targetView, timestamp: Date.now(), relatedId };
                this.notifications.unshift(newNotification);
                if (this.notifications.length > 10) this.notifications.pop();
            },
            handleNotificationClick(notification) {
                this.changeView(notification.targetView);
                this.notifications = this.notifications.filter(n => n.id !== notification.id);
                const activeDropdown = document.querySelector('.dropdown.dropdown-end.ml-2 label[tabindex="0"]');
                if(activeDropdown && typeof activeDropdown.blur === 'function') activeDropdown.blur();
                else if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur();
            },
            clearAllNotifications() {
                this.notifications = [];
                const activeDropdown = document.querySelector('.dropdown.dropdown-end.ml-2 label[tabindex="0"]');
                if(activeDropdown && typeof activeDropdown.blur === 'function') activeDropdown.blur();
                 else if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur();
            },

            // Game Control, Approval, Rules, and UI Utility functions
            startGame() {
                if (this.gameStatus === 'running' || this.gameStatus === 'paused') { this.showGameMessage("Game already in progress.", "warning"); return; }
                const activeRules = this.gameRules.filter(rule => rule.isActive);
                if (activeRules.length === 0) { this.showGameMessage("Select at least one rule.", "error"); this.currentView = 'rules'; return; }
                if (this.totalMoneyCollected === null || this.totalMoneyCollected < 0) { this.showGameMessage("Enter valid total money (can be 0).", "error"); this.currentView = 'rules'; return; }
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_START_GAME', payload: { rulesConfig: this.gameRules, totalMoneyCollected: this.totalMoneyCollected, callingMode: this.callingMode, autoCallInterval: this.autoCallInterval }})); else this.showGameMessage("WS not connected.", "error");
            },
            callNextNumber() {
                if (this.gameStatus !== 'running' || this.callingMode !== 'manual') { this.showGameMessage("Not in manual running mode.", "warning"); return; }
                if (this.calledNumbersHistory.length >= 90) { this.showGameMessage("All numbers called.", "info"); return; }
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_CALL_NUMBER' })); else this.showGameMessage("WS not connected.", "error");
            },
            pauseGame() {
                if (this.callingMode !== 'auto' || this.gameStatus !== 'running') { this.showGameMessage("Can only pause auto mode.", "warning"); return; }
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_PAUSE_GAME' })); else this.showGameMessage("WS not connected.", "error");
            },
            resumeGame() {
                if (this.callingMode !== 'auto' || this.gameStatus !== 'paused') { this.showGameMessage("Can only resume auto paused game.", "warning"); return; }
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_RESUME_GAME' })); else this.showGameMessage("WS not connected.", "error");
            },
            stopGame() {
                if (this.gameStatus === 'idle' || this.gameStatus === 'stopped' || this.gameStatus === 'connecting') { this.showGameMessage("Game not active or already stopped.", "warning"); return; }
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_STOP_GAME' })); else this.showGameMessage("WS not connected.", "error");
            },
            approveTicketRequest(playerId) { if (this.socket && this.socket.readyState === WebSocket.OPEN) { this.socket.send(JSON.stringify({ type: 'ADMIN_APPROVE_TICKET_REQUEST', payload: { targetPlayerId: playerId }})); this.pendingTicketRequests = this.pendingTicketRequests.filter(r => r.playerId !== playerId); this.showGameMessage('Approval sent.', 'info', 2000); } else this.showGameMessage("WS not connected.", "error"); },
            rejectTicketRequest(playerId, reason) { if (this.socket && this.socket.readyState === WebSocket.OPEN) { this.socket.send(JSON.stringify({ type: 'ADMIN_REJECT_TICKET_REQUEST', payload: { targetPlayerId: playerId, reason: reason }})); this.pendingTicketRequests = this.pendingTicketRequests.filter(r => r.playerId !== playerId); this.showGameMessage('Rejection sent.', 'info', 2000); } else this.showGameMessage("WS not connected.", "error"); },
            approvePrizeClaim(claim) { if (this.socket && this.socket.readyState === WebSocket.OPEN) { this.socket.send(JSON.stringify({ type: 'ADMIN_APPROVE_PRIZE_CLAIM', payload: { claimId: claim.claimId, targetPlayerId: claim.playerId, prizeName: claim.prizeName, prizeRuleId: claim.prizeRuleId }})); this.pendingPrizeClaims = this.pendingPrizeClaims.filter(c => c.claimId !== claim.claimId); this.showGameMessage('Approval sent.', 'info', 2000); } else this.showGameMessage("WS not connected.", "error"); },
            rejectPrizeClaim(claim, reason) { if (this.socket && this.socket.readyState === WebSocket.OPEN) { this.socket.send(JSON.stringify({ type: 'ADMIN_REJECT_PRIZE_CLAIM', payload: { claimId: claim.claimId, targetPlayerId: claim.playerId, prizeName: claim.prizeName, reason: reason }})); this.pendingPrizeClaims = this.pendingPrizeClaims.filter(c => c.claimId !== claim.claimId); this.showGameMessage('Rejection sent.', 'info', 2000); } else this.showGameMessage("WS not connected.", "error"); },

            handleActivationToggle(ruleId) {
                if (this.gameStatus === 'running' || this.gameStatus === 'paused') {
                    this.showGameMessage("Cannot change rules while game is active.", "warning");
                    // Revert toggle if needed (Alpine might have already updated model, so find and flip back)
                    this.$nextTick(() => {
                        const rule = this.gameRules.find(r => r.id === ruleId);
                        if (rule) rule.isActive = !rule.isActive;
                    });
                    return;
                }
                const rule = this.gameRules.find(r => r.id === ruleId);
                if(rule && !rule.isActive) { // If rule was just deactivated
                     rule.baseWeight = rule.originalWeight !== undefined ? rule.originalWeight : 0;
                } else if (rule && rule.isActive && rule.originalWeight === undefined) { // If just activated and no original weight
                    rule.originalWeight = rule.baseWeight; // Store current base as original
                }
                this.normalizeActiveRuleWeights();
                this.updateRuleCalculations();
            },
            handleBaseWeightInput(ruleId, inputValue) {
                if (this.gameStatus === 'running' || this.gameStatus === 'paused') {
                    this.showGameMessage("Cannot change rules while game is active.", "warning"); return;
                }
                const rule = this.gameRules.find(r => r.id === ruleId && r.isActive);
                if (rule) {
                    let newWeight = parseFloat(inputValue);
                    if(isNaN(newWeight) || newWeight < 0) newWeight = 0;
                    if(newWeight > 100) newWeight = 100;
                    rule.originalWeight = newWeight; // User's desired weight becomes the new original for proportion
                    this.normalizeActiveRuleWeights(ruleId, newWeight);
                    this.updateRuleCalculations();
                }
            },
            normalizeActiveRuleWeights(editedRuleId = null, newWeightForEditedRule = null) {
                let activeRules = this.gameRules.filter(r => r.isActive);
                if (activeRules.length === 0) {
                    this.totalSelectedWeight = 0;
                    this.gameRules.forEach(r => { r.baseWeight = r.originalWeight || 0; r.coinsPerPrize = 0;}); // Reset baseWeight to original or 0
                    // No need to call updateRuleCalculations from here, caller should do it.
                    return;
                }

                if (editedRuleId && newWeightForEditedRule !== null) {
                    const editedRule = activeRules.find(r => r.id === editedRuleId);
                    if (editedRule) {
                        editedRule.baseWeight = Math.max(0, Math.min(100, newWeightForEditedRule)); // User-set weight for this rule
                        const sumOfOtherOriginalWeights = activeRules.reduce((sum, r) => r.id !== editedRuleId ? sum + (r.originalWeight || 0) : sum, 0);
                        const remainingPercentage = 100 - editedRule.baseWeight;

                        if (activeRules.length > 1) {
                            activeRules.forEach(r => {
                                if (r.id !== editedRuleId) {
                                    if (sumOfOtherOriginalWeights > 0) {
                                        r.baseWeight = ((r.originalWeight || 0) / sumOfOtherOriginalWeights) * remainingPercentage;
                                    } else { // If other original weights are 0, distribute remaining equally
                                        r.baseWeight = remainingPercentage / (activeRules.length - 1);
                                    }
                                }
                            });
                        }
                    }
                } else { // General normalization (on activation/deactivation or init)
                    let sumOfActiveOriginalWeights = activeRules.reduce((sum, r) => sum + (r.originalWeight || 0), 0);
                    if (sumOfActiveOriginalWeights > 0) {
                        activeRules.forEach(r => r.baseWeight = ((r.originalWeight || 0) / sumOfActiveOriginalWeights) * 100);
                    } else { // All active original weights are 0, distribute 100% equally
                        activeRules.forEach(r => r.baseWeight = 100 / activeRules.length);
                    }
                }

                // Ensure sum of baseWeights for active rules is exactly 100
                let currentSum = activeRules.reduce((sum, r) => sum + (r.baseWeight || 0), 0);
                if (activeRules.length > 0 && Math.abs(currentSum - 100) > 0.001) {
                    const correctionFactor = 100 / currentSum;
                    activeRules.forEach(r => { r.baseWeight = (r.baseWeight || 0) * correctionFactor; });
                }
                // Clamp and fix precision for all rules, inactive ones keep original/zero baseWeight
                this.gameRules.forEach(r => {
                    if (r.isActive) {
                        r.baseWeight = parseFloat(Math.max(0, Math.min(100, (r.baseWeight || 0))).toFixed(4));
                    } else {
                        r.baseWeight = r.originalWeight || 0; // Or simply 0 for inactive if preferred
                    }
                });
                this.totalSelectedWeight = 100; // If activeRules.length > 0, we've normalized them to sum to 100
            },

            updateRuleCalculations() {
                const currentTotalMoneyCollected = parseFloat(this.totalMoneyCollected) || 0;
                let calculatedTotalPrizeValue = 0;
                this.gameRules.forEach(rule => {
                    if (rule.isActive) {
                        // Base weight is now a percentage of 100 for active rules
                        const moneyAllocatedToRule = ((rule.baseWeight || 0) / 100) * currentTotalMoneyCollected;
                        const maxPrizes = parseInt(rule.maxPrizes) || 1;
                        rule.coinsPerPrize = maxPrizes > 0 ? (moneyAllocatedToRule / maxPrizes) : 0;
                        calculatedTotalPrizeValue += moneyAllocatedToRule; // Sum of monetary values allocated
                    } else {
                        rule.coinsPerPrize = 0;
                    }
                });
                this.totalPotentialPrizeValue = calculatedTotalPrizeValue;
            },

            saveRulesConfiguration() {
                if (this.gameStatus === 'running' || this.gameStatus === 'paused') { this.showGameMessage("Cannot save rules while game is active.", "warning"); return; }
                // Ensure normalization one last time before saving
                this.normalizeActiveRuleWeights();
                this.updateRuleCalculations();
                if (this.socket && this.socket.readyState === WebSocket.OPEN) this.socket.send(JSON.stringify({ type: 'ADMIN_UPDATE_RULES', payload: { rules: this.gameRules, financials: { totalMoneyCollected: this.totalMoneyCollected }}})); else this.showGameMessage("WS not connected.", "error");
            },

            setTheme(themeName, event = null, closeDropdown = true) { document.documentElement.setAttribute('data-theme', themeName); localStorage.setItem('theme', themeName); if (closeDropdown && event && event.target) { const anchorElement = event.target; const dropdownRoot = anchorElement.closest('.dropdown'); const dropdownTriggerLabel = dropdownRoot?.querySelector('label[tabindex="0"]'); setTimeout(() => { if (document.activeElement && dropdownRoot && dropdownRoot.contains(document.activeElement)) { if (typeof document.activeElement.blur === 'function') document.activeElement.blur(); } if (dropdownTriggerLabel && typeof dropdownTriggerLabel.blur === 'function') dropdownTriggerLabel.blur(); }, 0);}},
            changeView(viewName) { this.currentView = viewName; this.isDrawerOpen = false; if (viewName === 'qrCode' && this.roomId && this.roomId !== 'N/A') { this.$nextTick(() => this.generateQRCode()); } },
            showGameMessage(text, type = 'info', duration = 3000) { this.gameMessage = text; this.gameMessageType = type; if (this.gameMessageTimeout) clearTimeout(this.gameMessageTimeout); if (duration !== null) { this.gameMessageTimeout = setTimeout(() => { this.gameMessage = ''; }, duration);}},
            generateQRCode() {
                const qrCanvas = document.getElementById('qrcodeCanvas');
                if (!qrCanvas) return;
                qrCanvas.innerHTML = '';
                if (!this.roomId || this.roomId === 'N/A') { qrCanvas.innerHTML = '<p class="text-error">Room ID not set.</p>'; return; }
                const playerJoinUrl = `${window.location.origin}/player_join.html?roomId=${encodeURIComponent(this.roomId)}`;
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(playerJoinUrl);
                    qr.make();
                    qrCanvas.innerHTML = qr.createImgTag(6, 8);
                    if(qrCanvas.firstChild) { qrCanvas.firstChild.style.width = '100%'; qrCanvas.firstChild.style.maxWidth = '256px'; qrCanvas.firstChild.style.height = 'auto';}
                } catch (e) { console.error("QR Code generation error:", e); qrCanvas.innerHTML = '<p class="text-error">Error generating QR code.</p>'; }
            }
        }
    }
    </script>
</body>
</html>
