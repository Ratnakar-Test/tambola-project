<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* ... (keep existing styles) ... */
    </style>
</head>
<body x-data="playerDashboard()" x-init="init()" class="bg-base-200 flex flex-col min-h-screen">
    <script>
function playerDashboard() {
    return {
        // ... (keep existing state properties) ...
        
        socket: null,

        init() {
            // ... (keep existing init setup like URL parsing) ...

            console.log("Initializing player dashboard..."); // Log init start

            // Socket connection
            const socketUrl = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
                              ? "http://localhost:3000"
                              : 'https://tambola-backend.onrender.com'; // Replace with your actual Render URL if different
            console.log(`Attempting to connect to Socket.IO server at: ${socketUrl}`);
            this.socket = io(socketUrl, {
                // Optional: Add transports for robustness, though defaults are usually fine
                // transports: ['websocket', 'polling']
            });

            // --- Socket Event Handlers ---
            this.socket.on('connect', () => {
                console.log(`Socket connected successfully! ID: ${this.socket.id}`); // Log success
                this.addNotification('Connected to server.', 'success');
                // Clear connection errors on successful connect
                this.errorMsg = '';
                // If previously connected and in a room, try to rejoin (or prompt user)
                // Rejoining logic needs careful implementation on both client and server
            });

            this.socket.on('connect_error', (err) => {
                // Log the full error object for details
                console.error('Socket Connection Error:', err);
                this.errorMsg = `Connection Error: ${err.message}. Server may be down or unreachable.`;
                this.connected = false; // Ensure state reflects disconnection
                this.addNotification('Connection failed. Please check server status and refresh.', 'error', 10000); // Longer duration
            });

            this.socket.on('disconnect', (reason) => {
                // Log the reason for disconnect - THIS IS IMPORTANT
                console.error(`Socket disconnected. Reason: "${reason}"`);
                this.addNotification(`Disconnected: ${reason}. Attempting to reconnect...`, 'error');
                this.connected = false;
                // Consider if you need to reset game state here, e.g., clear tickets if rejoin isn't handled
                // this.tickets = [];
                // this.called = [];
                // this.gameState = 'stopped';
            });

            // ... (keep existing application-specific event handlers like 'player-joined', 'number-called', etc.) ...
            
             this.socket.on('player-joined', data => {
                if (data.playerName !== this.playerName) {
                    this.addNotification(`${data.playerName} joined the room.`);
                }
                 console.log('Event received: player-joined', data);
            });
            
            this.socket.on('player-left', data => {
                 this.addNotification(`${data.playerName} left the room.`);
                 console.log('Event received: player-left', data);
            });

            this.socket.on('number-called', data => {
                this.called = data.calledNumbers;
                if (this.autoMark) {
                    this.applyAutoMark();
                }
                console.log('Event received: number-called', data);
            });
            
            // ... other handlers ...

             this.socket.on('room-error', data => {
                console.error('Room Error from Server:', data.error);
                this.errorMsg = data.error;
                this.addNotification(data.error, 'error');
            });
             this.socket.on('server-error', data => {
                console.error('Generic Server Error:', data.message);
                this.errorMsg = data.message;
                this.addNotification(data.message, 'error');
            });


        }, // End init()

        // ... (keep existing methods like joinRoom, confirmRequestTicket, submitClaim, etc.) ...

        addNotification(text, type = 'info', duration = 5000) {
            const id = Date.now();
            // Avoid duplicate notifications if possible
            if (!this.notifications.some(n => n.text === text && n.type === type)) {
                 this.notifications.push({ id, text, type });
                 setTimeout(() => {
                    this.removeNotification(id);
                 }, duration);
            }
        },
        removeNotification(id) {
             this.notifications = this.notifications.filter(n => n.id !== id);
        },

        // ... (keep other methods)

    } // End return
} // End playerDashboard()
</script>
</body>
</html>
